<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Coach JeetPT</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<style>
  body {font-family: Arial, system-ui, -apple-system; background:#07102a;color:#e6eef8;margin:20px;}
  .card{background:#0b1220;padding:14px;border-radius:10px;margin-bottom:20px;}
  #chatbox{height:420px;overflow:auto;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:6px;display:flex;flex-direction:column;}
  .msg{margin:6px 0;padding:6px;border-radius:6px;max-width:80%;white-space:pre-wrap;}
  .user{background:rgba(99,102,241,0.15);align-self:flex-end;}
  .bot{background:rgba(255,255,255,0.03);align-self:flex-start;}
  .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .btn{background:#7c3aed;border:none;padding:6px 12px;border-radius:6px;color:white;cursor:pointer;}
  .small{opacity:.8;font-size:12px;margin-left:8px}
  input#userInput{min-width:260px}
  .hidden{display:none}
  .tag{display:inline-block;background:#1a2448;border:1px solid #24305e;border-radius:4px;padding:1px 6px;margin-left:6px;font-size:12px;opacity:.9}
  .chatTable{border-collapse:collapse;margin:6px 0;width:100%;font-size:13px;}
  .chatTable th,.chatTable td{border:1px solid rgba(255,255,255,0.2);padding:4px 6px;}
  .chatTable th{background:rgba(255,255,255,0.1);font-weight:bold;}
  mark{background:#facc15;color:#000;padding:0 2px;border-radius:2px;}
</style>
</head>
<body>

<div class="card">
  <h2>Coach JeetPT</h2>
  <div>
    Mode: <span id="modeLabel">User</span>
    <span class="small">â€” Excel KB + Multiâ€‘PDF (Configâ€‘driven via OneDrive)</span>
  </div>
  <div id="chatbox"></div>

  <div class="controls">
    <input id="userInput" placeholder="Ask a question" style="flex:1;">
    <button id="sendBtn" class="btn">Send</button>
    <button id="adminToggleBtn" class="btn">Admin Login</button>
    <button id="reloadBtn" class="btn" title="Reload KB + PDFs">Reload</button>
    <button id="switchBtn" class="btn" title="Clear token & reâ€‘login">Switch Account</button>
    <span id="pdfCount" class="tag hidden">PDF: 0</span>
  </div>
</div>

<script>
// ===== CONFIG =====
const clientId    = "7f3c8426-3ef5-4e28-acf0-5f51224bc0a6";
const redirectUri = "https://jacjessie.github.io/learning-coach/";
const scopes      = "Files.ReadWrite.All User.Read";

// Excel workbook link (KB + Admin + Config)
const shareLink   = "https://xvxky-my.sharepoint.com/:x:/g/personal/jacjessie_xvxky_onmicrosoft_com/Ef4Mr6_ZWd1Dm0D6mAe2ffkBI4syJuD6xhj-ekpItxdyXw?e=8VIx5C";

// ===== STATE =====
let kb = [];
let docKb = []; // { text, source:'PDF', page, pdfIndex }
let pdfWebUrls = []; // index -> webUrl for each PDF from Config
let pdfNames  = []; // index -> display label (e.g., "Dayforce Guide")
let isAdmin = false;
let accessToken = null;
let workbookBase = null;

// ===== UI =====
function addChat(sender, html){
  const el = document.createElement("div");
  el.className = "msg " + (sender === "User" ? "user" : "bot");
  if(sender === "User") el.textContent = "You: " + html; else el.innerHTML = "Bot:<br>" + markdownTablesToHtml(html);
  const box = document.getElementById("chatbox");
  box.appendChild(el); box.scrollTop = box.scrollHeight;
}

function markdownTablesToHtml(md){
  const blocks = md.split(/\n\s*\n/);
  return blocks.map(block => {
    if (/^\s*\|.*\|\s*$/m.test(block)) {
      const rows = block.trim().split("\n");
      return "<table class='chatTable'>" +
        rows.map((row, idx) => {
          const cols = row.trim().split("|").slice(1, -1).map(c => c.trim());
          if (idx === 1 && /^-+$/.test(cols[0])) return ""; // md separator row
          const tag = (idx === 0) ? "th" : "td";
          return "<tr>" + cols.map(c => `<${tag}>${c}</${tag}>`).join("") + "</tr>";
        }).join("") +
        "</table>";
    }
    return "<p>" + block + "</p>";
  }).join("");
}

// ===== Fuzzy search =====
function levenshtein(a,b){if(!a||!b) return a||b ? Math.max(a.length,b.length) : 0;const m=a.length,n=b.length,dp=Array(m+1).fill(0).map(()=>Array(n+1).fill(0));for(let i=0;i<=m;i++) dp[i][0]=i;for(let j=0;j<=n;j++) dp[0][j]=j;for(let i=1;i<=m;i++) for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1;dp[i][j]=Math.min(dp[i-1][j]+1, dp[i][j-1]+1, dp[i-1][j-1]+c);}return dp[m][n];}
function normalizedSimilarity(a,b){a=(a||"").toLowerCase();b=(b||"").toLowerCase();const d=levenshtein(a,b), M=Math.max(a.length,b.length);return M ? 1 - d/M : 1;}
function scoreMatch(q,t){return normalizedSimilarity(q,t);}

function searchKB(query){
  const pool = [...kb, ...docKb];
  const scored = pool.map(k => {
    let score = scoreMatch(query, k.text);
    if (k.source === 'PDF') score += 0.15; // Boost PDF slightly
    return { item: k, score };
  })
  .sort((a,b)=>b.score-a.score)
  .filter(x=>x.score>0.2)
  .slice(0,8);
  return scored;
}

function composeReply(query){
  const hits = searchKB(query);
  if(hits.length===0) return `No relevant info found.
Try Dayforce Help: https://help.dayforce.com/`;

  let reply = "Keyword Search:

| Keyword |
|---------|
| "+query+" |

";
  reply += "Answers Found:

| # | Snippet | Source |
|---|----------|--------|
";
  const regex = new RegExp(`(${query})`, "ig");
  hits.forEach((h, i) => {
    let snippet = h.item.text.replace(/
/g, " ");
    if (snippet.length > 180) snippet = snippet.slice(0, 180) + "...";
    snippet = snippet.replace(regex, "<mark>$1</mark>");
    let src = "Excel";
    if (h.item.source === 'PDF') {
      const web = pdfWebUrls[h.item.pdfIndex] || "";
      const label = (pdfNames[h.item.pdfIndex] || 'PDF');
      src = web ? `<a href="${web}#page=${h.item.page}" target="_blank">${label} p.${h.item.page}</a>` : `${label} p.${h.item.page}`;
    }
    reply += `| ${i+1} | ${snippet} | ${src} |
`;
  });
  return reply;
}

// ===== Graph helpers =====
async function gFetch(url, options={}){
  const res = await fetch(url, options);
  if (!res.ok){ let text=""; try{text=await res.text();}catch(e){}; throw new Error(`HTTP ${res.status} ${res.statusText}\nURL: ${url}\n${text}`); }
  const ct = res.headers.get("content-type") || "";
  if (ct.includes("application/json")) return res.json();
  if (ct.includes("application/pdf") || ct.includes("application/octet-stream")) return res.arrayBuffer();
  return res.text();
}
function toGraphShareId(url){ let b=btoa(url).replace(/=+$/,'').replace(/\+/g,'-').replace(/\//g,'_'); return 'u!'+b; }

// ===== OAuth =====
function loginMicrosoftGraph(){
  const tenant = "common";
  const params = new URLSearchParams({ client_id:clientId, response_type:"token", redirect_uri:redirectUri, scope:scopes, prompt:"select_account" });
  window.location.href = `https://login.microsoftonline.com/${tenant}/oauth2/v2.0/authorize?${params}`;
}
function getTokenFromHash(){
  if (window.location.hash){
    const p = new URLSearchParams(window.location.hash.substring(1));
    const t = p.get("access_token");
    if (t){ accessToken=t; window.location.hash=""; fetchExcelKBAndPdfs(); }
  }
}

// ===== Excel KB + Config (multiâ€‘PDF) =====
async function resolveWorkbookBase(){
  if (workbookBase) return;
  const shareId = toGraphShareId(shareLink);
  const item = await gFetch(`https://graph.microsoft.com/v1.0/shares/${shareId}/driveItem`, { headers:{ Authorization:"Bearer "+accessToken } });
  workbookBase = `https://graph.microsoft.com/v1.0/drives/${item.parentReference.driveId}/items/${item.id}/workbook`;
}

async function readKnowledgeRows(){
  try {
    const tData = await gFetch(`${workbookBase}/tables`, { headers:{ Authorization:'Bearer '+accessToken } });
    const t = (tData.value||[]).find(x => (x.name||'').toLowerCase()==='knowledgetable');
    if (t){
      const rowsData = await gFetch(`${workbookBase}/tables('${t.name}')/rows`, { headers:{ Authorization:'Bearer '+accessToken } });
      return (rowsData.value||[]).map(r => (r.values && r.values[0] && r.values[0][0]) ? String(r.values[0][0]).trim() : "").filter(Boolean);
    }
    const data = await gFetch(`${workbookBase}/worksheets('Knowledge')/range(address='A2:A20000')`, { headers:{ Authorization:'Bearer '+accessToken } });
    const vals = Array.isArray(data.values) ? data.values : [];
    return vals.map(r => (r && r[0] ? String(r[0]).trim() : "")).filter(Boolean);
  } catch (err){ addChat("Bot", "Error reading Knowledge: "+err.message); return []; }
}

async function readPdfLinksFromConfig(){
  // Supports either:
  //  a) Table named ConfigTable with columns: Name | PDFLink
  //  b) Raw range in Config sheet: A2:A (links only) OR A2:B (Name | Link)
  let entries = [];
  // Try table first
  try {
    const tData = await gFetch(`${workbookBase}/tables`, { headers:{ Authorization:'Bearer '+accessToken } });
    const t = (tData.value||[]).find(x => (x.name||'').toLowerCase()==='configtable');
    if (t){
      const headerRes = await gFetch(`${workbookBase}/tables('${t.name}')/headerRowRange`, { headers:{ Authorization:'Bearer '+accessToken } });
      const headers = (headerRes.values && headerRes.values[0]) ? headerRes.values[0].map(v=>String(v).trim().toLowerCase()) : [];
      const nameIdx = headers.indexOf('name');
      const linkIdx = headers.indexOf('pdflink');
      const rowsData = await gFetch(`${workbookBase}/tables('${t.name}')/rows`, { headers:{ Authorization:'Bearer '+accessToken } });
      entries = (rowsData.value||[]).map(r => {
        const row = (r.values && r.values[0]) ? r.values[0] : [];
        const name = nameIdx>=0 ? String(row[nameIdx]||'').trim() : '';
        const link = linkIdx>=0 ? String(row[linkIdx]||'').trim() : '';
        return { name, link };
      }).filter(e => /^https?:\/\//i.test(e.link));
      if (entries.length) return entries;
    }
  } catch (e) { /* fall back to ranges */ }

  // Fallback: ranges
  try {
    // Try two-column Name|Link first
    const data = await gFetch(`${workbookBase}/worksheets('Config')/range(address='A2:B200')`, { headers:{ Authorization:'Bearer '+accessToken } });
    const vals = Array.isArray(data.values) ? data.values : [];
    entries = vals.map(r => ({ name: String(r[0]||'').trim(), link: String(r[1]||'').trim() }))
                  .filter(e => /^https?:\/\//i.test(e.link));
    if (entries.length) return entries;
  } catch (e) { /* continue */ }
  try {
    // Last resort: single column links only
    const data = await gFetch(`${workbookBase}/worksheets('Config')/range(address='A2:A200')`, { headers:{ Authorization:'Bearer '+accessToken } });
    const vals = Array.isArray(data.values) ? data.values : [];
    entries = vals.map(r => ({ name: '', link: (r && r[0] ? String(r[0]).trim() : '') }))
                  .filter(e => /^https?:\/\//i.test(e.link));
  } catch (err){ addChat("Bot", "Config sheet missing or PDF links not found."); }
  return entries;
}

async function fetchExcelKBAndPdfs(){
  try {
    await resolveWorkbookBase();
    const knowledgeTexts = await readKnowledgeRows();
    kb = knowledgeTexts.map(text => ({ text }));
    addChat("Bot", "Excel KB loaded.");

    const pdfEntries = await readPdfLinksFromConfig();
    if (!pdfEntries.length){ addChat("Bot", "No PDF links found in Config. Add either a ConfigTable (Name | PDFLink) or values in Config!A2:Bâ€¦"); return; }

    // Reset PDF state
    pdfWebUrls = []; pdfNames = []; docKb = [];

    for (let idx = 0; idx < pdfEntries.length; idx++){
      const { name, link } = pdfEntries[idx];
      pdfNames[idx] = name || 'PDF';
      try { await fetchSinglePdfFromOneDrive(link, idx); }
      catch (e){ addChat("Bot", `Error loading PDF ${idx+1} (${pdfNames[idx]}): ${e.message}`); }
    }

    const total = docKb.length;
    const tag = document.getElementById("pdfCount");
    tag.textContent = `PDF: ${total}`; tag.classList.remove("hidden");
    addChat("Bot", `Indexed ${total} chunks from ${pdfEntries.length} PDF(s).`);
  } catch (err){ addChat("Bot", "Error loading KB/PDFs: "+err.message); }
}
(){
  try {
    await resolveWorkbookBase();
    const knowledgeTexts = await readKnowledgeRows();
    kb = knowledgeTexts.map(text => ({ text }));
    addChat("Bot", "Excel KB loaded.");

    const pdfLinks = await readPdfLinksFromConfig();
    if (!pdfLinks.length){ addChat("Bot", "No PDF links found in Config. Add links in Config!A2:Aâ€¦ or in ConfigTable."); return; }

    // Reset PDF state
    pdfWebUrls = []; docKb = [];

    // Fetch and index each PDF sequentially (clear error isolation)
    for (let idx = 0; idx < pdfLinks.length; idx++){
      const link = pdfLinks[idx];
      try { await fetchSinglePdfFromOneDrive(link, idx); }
      catch (e){ addChat("Bot", `Error loading PDF ${idx+1}: ${e.message}`); }
    }

    const total = docKb.length;
    const tag = document.getElementById("pdfCount");
    tag.textContent = `PDF: ${total}`; tag.classList.remove("hidden");
    addChat("Bot", `Indexed ${total} chunks from ${pdfLinks.length} PDF(s).`);
  } catch (err){ addChat("Bot", "Error loading KB/PDFs: "+err.message); }
}

async function fetchSinglePdfFromOneDrive(pdfShareLink, pdfIndex){
  const shareId = toGraphShareId(pdfShareLink);
  const item = await gFetch(`https://graph.microsoft.com/v1.0/shares/${shareId}/driveItem`, { headers:{ Authorization:"Bearer "+accessToken } });
  const webUrl = item.webUrl; pdfWebUrls[pdfIndex] = webUrl;
  const driveId = item.parentReference.driveId; const itemId = item.id;

  const buf = await gFetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${itemId}/content`, { headers:{ Authorization:'Bearer '+accessToken } });
  const pdf = await pdfjsLib.getDocument({ data: buf }).promise;

  let extracted = 0;
  for (let p = 1; p <= pdf.numPages; p++){
    const page = await pdf.getPage(p);
    const tc = await page.getTextContent();
    const txt = tc.items.map(it => it.str).join(" ").replace(/\s+/g, " ").trim();
    const chunkSize = 500, overlap = 80;
    for (let i = 0; i < txt.length; i += (chunkSize - overlap)){
      const chunk = txt.slice(i, i + chunkSize).trim();
      if (chunk.length > 60){
        docKb.push({ text: chunk, source: 'PDF', page: p, pdfIndex });
        extracted++;
      }
    }
  }
  addChat("Bot", `Parsed PDF ${pdfIndex+1}: ${extracted} chunks.`);
}

// Render miniature sources list
function renderSources(){
  const wrap = document.getElementById('sourcesWrap');
  const panel = document.getElementById('sourcesPanel');
  if (!wrap || !panel) return;
  wrap.innerHTML = '';
  const any = pdfWebUrls.length > 0;
  panel.classList.toggle('hidden', !any);
  if (!any) return;
  pdfWebUrls.forEach((url, idx) => {
    const name = (pdfNames[idx] || 'PDF');
    const a = document.createElement('a'); a.href = `${url}#page=1`; a.target = '_blank'; a.textContent = name;
    const span = document.createElement('span'); span.className = 'sourceTag';
    const count = docKb.filter(x => x.pdfIndex === idx).length;
    span.innerHTML = `<span>ðŸ“„</span>`; span.appendChild(a); span.insertAdjacentHTML('beforeend', `<span style="opacity:.7">(${count})</span>`);
    wrap.appendChild(span);
  });
}

// ===== Controls =====
async function handleInput(){
  const val = document.getElementById("userInput").value.trim();
  if (!val) return;
  document.getElementById("userInput").value = "";
  addChat("User", val);
  addChat("Bot", composeReply(val));
}

document.getElementById("sendBtn").addEventListener("click", handleInput);
(document.getElementById("userInput")).addEventListener("keydown", e=>{ if(e.key==="Enter") handleInput(); });
document.getElementById("reloadBtn").addEventListener("click", ()=>{ if(accessToken) fetchExcelKBAndPdfs(); });
document.getElementById("switchBtn").addEventListener("click", ()=>{ accessToken=null; workbookBase=null; addChat("Bot","Token cleared. Reâ€‘login."); });

document.getElementById("adminToggleBtn").addEventListener("click", ()=>{ isAdmin = !isAdmin; document.getElementById("modeLabel").textContent = isAdmin ? "Admin" : "User"; });

// ===== OAuth bootstrap =====
function startAuthIfNeeded(){ if(!accessToken) loginMicrosoftGraph(); }
function ensureAuthThenInit(){ if(accessToken) fetchExcelKBAndPdfs(); else startAuthIfNeeded(); }

function init(){ getTokenFromHash(); if(!accessToken){ addChat("Bot","Click Admin Login to sign in."); } }

init();
</script>
</body>
</html>
