<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Coach JeetPT</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body {font-family: Arial; background:#07102a;color:#e6eef8;margin:20px;}
.card{background:#0b1220;padding:14px;border-radius:10px;margin-bottom:20px;}
#chatbox{height:400px;overflow:auto;border:1px solid rgba(255,255,255,0.03);padding:8px;border-radius:6px;display:flex;flex-direction:column;}
.msg{margin:6px 0;padding:6px;border-radius:6px;max-width:80%;}
.user{background:rgba(99,102,241,0.15);align-self:flex-end;}
.bot{background:rgba(255,255,255,0.03);align-self:flex-start;}
.controls{display:flex;gap:8px;margin-top:8px;}
.btn{background:#7c3aed;border:none;padding:6px 12px;border-radius:6px;color:white;cursor:pointer;}
.small{opacity:.8;font-size:12px;margin-left:8px}
</style>
</head>
<body>

<div class="card">
  <h2>Coach JeetPT</h2>
  <div>Mode: <span id="modeLabel">User</span><span class="small"> — errors will be printed here if Graph calls fail</span></div>
  <div id="chatbox"></div>
  <div class="controls">
    <input id="userInput" placeholder="Ask a question or /learn (admin)" style="flex:1;">
    <button id="sendBtn" class="btn">Send</button>
    <button id="adminToggleBtn" class="btn">Admin Login</button>
    <button id="reloadBtn" class="btn" title="Reload KB from OneDrive">Reload KB</button>
    <button id="switchBtn" class="btn" title="Clear token & re-login">Switch Account</button>
  </div>
</div>

<script>
// ===== CONFIG =====
const clientId   = "7f3c8426-3ef5-4e28-acf0-5f51224bc0a6";
const redirectUri= "https://jacjessie.github.io/learning-coach/"; // hardcoded to your site root
const scopes     = "Files.ReadWrite.All User.Read";
const shareLink  = "https://xvxky-my.sharepoint.com/:x:/g/personal/jacjessie_xvxky_onmicrosoft_com/Ef4Mr6_ZWd1Dm0D6mAe2ffkBiGIOj00iRvJvJACuArT7cQ?e=IZ8qpd";

let kb=[], hiddenKb=[], isAdmin=false, adminPassword="admin123";
let accessToken=null, workbookBase=null;

// ===== UI helpers =====
function addChat(sender,text){
  const el=document.createElement("div");
  el.className="msg "+(sender==="User"?"user":"bot");
  el.textContent=(sender==="User"?"You: ":"Bot: ")+text;
  document.getElementById("chatbox").appendChild(el);
  document.getElementById("chatbox").scrollTop=document.getElementById("chatbox").scrollHeight;
}

// ===== Diagnostics fetch =====
async function gFetch(url,opt={}){
  const res=await fetch(url,opt);
  if(!res.ok){
    let text=""; try{text=await res.text();}catch(e){}
    throw new Error(`HTTP ${res.status} ${res.statusText}\nURL: ${url}\n${text}`);
  }
  const ct=res.headers.get("content-type")||"";
  if(ct.includes("application/json")) return res.json();
  return res.text();
}
function showErrorToChat(err,hint=""){ console.error(err); addChat("Bot",`Error:\n${err.message||err}${hint?`\nHint: ${hint}`:""}`); }

// ===== OAuth =====
function loginMicrosoftGraph(){
  const tenant="common"; // multi-tenant
  const params=new URLSearchParams({
    client_id:clientId,
    response_type:"token",
    redirect_uri:redirectUri,
    scope:scopes,
    prompt:"select_account"
  });
  window.location.href=`https://login.microsoftonline.com/${tenant}/oauth2/v2.0/authorize?${params}`;
}
function getTokenFromHash(){
  if(window.location.hash){
    const p=new URLSearchParams(window.location.hash.substring(1));
    const t=p.get("access_token");
    if(t){ accessToken=t; window.location.hash=""; fetchExcelKB(); }
  }
}

// ===== File resolution =====
function toBase64Url(u){ return btoa(u).replace(/=+$/,"").replace(/\+/g,"-").replace(/\//g,"_"); }
async function resolveWorkbookBase(){
  if(workbookBase) return;
  try{
    const encoded=toBase64Url(shareLink);
    const item=await gFetch(`https://graph.microsoft.com/v1.0/shares/${encoded}/driveItem`,{headers:{Authorization:"Bearer "+accessToken}});
    workbookBase=`https://graph.microsoft.com/v1.0/drives/${item.parentReference.driveId}/items/${item.id}/workbook`;
  }catch(e){showErrorToChat(e,"Check file sharing. Make sure this account can open the share link.");throw e;}
}

// ===== Knowledge/Admin read/write (trimmed for brevity, same logic as diagnostics build) =====
// ... keep your functions for readKnowledgeRows, readAdminPassword, fetchExcelKB, ensureKnowledgeTable, appendKnowledgeToExcel, ensureAdminTable, updateAdminPassword here ...

// (to save space, I didn’t inline them again since you already have the diagnostic version. Just replace your loginMicrosoftGraph with this new one.)
</script>
</body>
</html>

