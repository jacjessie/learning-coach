<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TALENT MODULE COACH</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<style>
  body {font-family: Arial, system-ui, -apple-system; background:#07102a;color:#e6eef8;margin:20px;}
  .card{background:#0b1220;padding:14px;border-radius:14px;margin-bottom:20px;position:relative;}
  #chatbox{height:420px;overflow:auto;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;display:flex;flex-direction:column;}
  .msg{margin:6px 0;padding:8px;border-radius:8px;max-width:80%;white-space:pre-wrap;}
  .user{background:rgba(99,102,241,0.15);align-self:flex-end;}
  .bot{background:rgba(255,255,255,0.03);align-self:flex-start;}
  .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap; align-items:flex-start}
  .btn{background:#7c3aed;border:none;padding:6px 12px;border-radius:8px;color:white;cursor:pointer;}
  .btn.secondary{background:#475569}
  .btn.ghost{background:transparent;border:1px solid #33447a;color:#cfe0ff}
  .small{opacity:.8;font-size:12px;margin-left:8px}
  #userInput {min-width:260px; font-family: inherit; line-height:1.4; resize:none; overflow:hidden;}
  .hidden{display:none}
  .tag{display:inline-block;background:#1a2448;border:1px solid #24305e;border-radius:14px;padding:2px 8px;margin-left:6px;font-size:12px;opacity:.9}
  .chatTable{border-collapse:collapse;margin:6px 0;width:100%;font-size:13px;}
  .chatTable th,.chatTable td{border:1px solid rgba(255,255,255,0.2);padding:4px 6px;}
  .chatTable th{background:rgba(255,255,255,0.1);font-weight:bold;}
  mark{background:#facc15;color:#000;padding:0 2px;border-radius:2px;}
  .sourceTag{display:inline-flex;align-items:center;gap:6px;background:#0f1a3d;border:1px solid #22336b;border-radius:14px;padding:3px 8px;margin:3px 6px 0 0;}
  .sourceTag a{color:#cbd5ff;text-decoration:none}
  .sourceTag a:hover{text-decoration:underline}
  .sourcesWrap{display:flex;flex-wrap:wrap}
  .notice{background:#13213d;border:1px solid #23386b;color:#cfe0ff;padding:6px 10px;border-radius:8px;margin-bottom:6px;font-size:12px;display:flex;align-items:center;gap:8px;}
  .notice::before{content:'⚠️';}

  /* Spinner for status */
  .spinner { width:14px; height:14px; border:2px solid rgba(255,255,255,0.25); border-top-color:#cbd5ff; border-radius:50%; animation:spin 0.9s linear infinite; }
  @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }

  /* Status row */
  .status { display:flex; align-items:center; gap:10px; margin-top:6px; font-size:12px; opacity:.9; }
  .status .bar { width:220px; height:6px; background:rgba(255,255,255,0.15); border-radius:6px; overflow:hidden; }
  .status .bar > span { display:block; height:100%; width:0%; background:#7c3aed; transition:width .2s; }

  /* Public link box */
  .pubbox{background:#0d1934;border:1px dashed #33447a;border-radius:8px;padding:8px;color:#cfe0ff;font-size:12px;margin-top:6px}
  .pubbox input{width:100%;background:#0b152d;border:1px solid #2a3a6c;color:#cfe0ff;border-radius:6px;padding:6px 8px;margin-top:6px}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal.hidden{display:none}
  .modal .box{background:#0b1220;border:1px solid #24305e;border-radius:12px;padding:16px;min-width:320px;max-width:720px;color:#e6eef8;box-shadow:0 8px 40px rgba(0,0,0,0.4)}
  .modal .box h3{margin:0 0 8px 0}
  .modal .row{display:flex;gap:8px;align-items:center;margin:6px 0}
  .modal input{flex:1;background:#0b152d;border:1px solid #2a3a6c;color:#cfe0ff;border-radius:6px;padding:8px}
  .toast{position:fixed;right:16px;bottom:16px;background:#102247;border:1px solid #3756a1;color:#dbe6ff;padding:8px 12px;border-radius:8px;opacity:0;transform:translateY(8px);transition:.25s;z-index:60}
  .toast.show{opacity:1;transform:none}

  /* Toggle */
  .toggle{display:flex;align-items:center;gap:8px;font-size:12px;opacity:.95}
  .toggle input{transform:scale(1.1)}
</style>
</head>
<body>

<div class="card">
  <h2>TALENT MODULE COACH</h2>
  <div>
    Mode: <span id="modeLabel">User</span>
    <span class="small">— Public JSON cache (no login for users). Admin can publish/update from OneDrive.</span>
  </div>
  <div id="chatbox"></div>

  <div class="controls">
    <div style="flex:1; min-width:280px;">
      <div class="notice">Always review TMCoach’s answers and never enter PII.</div>
      <textarea id="userInput" placeholder="Ask question + include the module. Ex. Interview Scheduling - Recruiting" rows="1" style="width:100%;"></textarea>
      <div id="pubCacheBox" class="pubbox hidden">
        <div><strong>Public cache link</strong> (used for User mode):</div>
        <input id="publicCacheInput" placeholder="Paste public JSON link here (ends with .json or ?download=1)" />
        <div style="display:flex;gap:6px;margin-top:6px;flex-wrap:wrap;">
          <button id="savePublicCacheBtn" class="btn">Use this link</button>
          <button id="clearPublicCacheBtn" class="btn secondary">Clear</button>
          <button id="showShareBtn" class="btn ghost hidden" title="Show shareable app link again">Show App Link</button>
          <label class="toggle"><input type="checkbox" id="makePublicPdfs"> Make PDF links publicly viewable</label>
        </div>
        <div class="small" id="publicCacheHint" style="margin-top:6px;opacity:.8"></div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <button id="sendBtn" class="btn">Send</button>
      <button id="adminToggleBtn" class="btn" title="Sign in to OneDrive (Admin)">Admin Login</button>
      <button id="buildCacheBtn" class="btn hidden" title="Build cache from Excel + PDFs (Admin)">Build Cache</button>
      <button id="publishCacheBtn" class="btn hidden" title="Publish public JSON cache (Admin)">Publish Public Cache</button>
      <button id="switchBtn" class="btn hidden" title="Switch Microsoft account (Admin)">Switch Account</button>
      <span id="pdfCount" class="tag hidden">PDF: 0</span>
    </div>
  </div>

  <!-- Tiny Sources panel -->
  <div id="sourcesPanel" class="small hidden" style="margin-top:8px;">
    <div style="opacity:.8;margin-bottom:4px;">Sources:</div>
    <div id="sourcesWrap" class="sourcesWrap"></div>
  </div>

  <!-- Loading / progress status -->
  <div id="loadStatus" class="status hidden">
    <div class="spinner"></div>
    <span id="statusText">Loading…</span>
    <div class="bar"><span id="statusFill"></span></div>
  </div>
</div>

<!-- Share Modal -->
<div id="shareModal" class="modal hidden" role="dialog" aria-modal="true">
  <div class="box">
    <h3>Share this app</h3>
    <div class="row">
      <label style="min-width:110px">App URL</label>
      <input id="shareAppUrlInput" readonly>
      <button id="copyAppUrlBtn" class="btn">Copy</button>
    </div>
    <div class="row">
      <label style="min-width:110px">Cache JSON</label>
      <input id="shareCacheUrlInput" readonly>
      <button id="copyCacheUrlBtn" class="btn">Copy</button>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="closeShareModalBtn" class="btn secondary">Close</button>
    </div>
  </div>
</div>

<div id="toast" class="toast">Copied!</div>

<script>
// ===== CONFIG =====
const clientId    = "7f3c8426-3ef5-4e28-acf0-5f51224bc0a6";
const redirectUri = "https://jacjessie.github.io/learning-coach/";
const scopes      = "Files.ReadWrite.All User.Read";
const shareLink   = "https://xvxky-my.sharepoint.com/:x:/g/personal/jacjessie_xvxky_onmicrosoft_com/Ef4Mr6_ZWd1Dm0D6mAe2ffkBI4syJuD6xhj-ekpItxdyXw?e=8VIx5C";
const PUBLIC_CACHE_NAME = "tmcoach_cache.json";
const TOGGLE_KEY = "tmc_make_public_pdfs"; // remember toggle across admin sessions

// ===== STATE =====
let kb = [], docKb = [], pdfWebUrls = [], pdfNames = [];
let pdfItemIds = [], pdfDriveIds = [];
let isAdmin = false, accessToken = null, workbookBase = null;
let driveId=null, excelItemId=null, parentFolderId=null;
let publicCacheUrl = null;
let lastShareAppUrl = null;

// ===== UI =====
function addChat(sender, html){
  const el = document.createElement("div");
  el.className = "msg " + (sender === "User" ? "user" : "bot");
  if(sender === "User") el.textContent = "You: " + html; else el.innerHTML = "Bot:<br>" + markdownTablesToHtml(html);
  const box = document.getElementById("chatbox");
  box.appendChild(el); box.scrollTop = box.scrollHeight;
}
function markdownTablesToHtml(md){
  const blocks = (md || "").split(/\n\s*\n/);
  return blocks.map(block => {
    if (/^\s*\|.*\|\s*$/m.test(block)) {
      const rows = block.trim().split("\n");
      return "<table class='chatTable'>" +
        rows.map((row, idx) => {
          const cols = row.trim().split("|").slice(1, -1).map(c => c.trim());
          if (idx === 1 && /^-+$/.test(cols[0])) return "";
          const tag = (idx === 0) ? "th" : "td";
          return "<tr>" + cols.map(c => `<${tag}>${c}</${tag}>`).join("") + "</tr>";
        }).join("") +
        "</table>";
    }
    return "<p>" + block + "</p>";
  }).join("");
}
function renderSources(){
  const wrap = document.getElementById('sourcesWrap');
  const panel = document.getElementById('sourcesPanel');
  if (!wrap || !panel) return;
  wrap.innerHTML = '';
  const any = pdfWebUrls.length > 0;
  panel.classList.toggle('hidden', !any);
  if (!any) return;
  pdfWebUrls.forEach((url, idx) => {
    const name = (pdfNames[idx] || 'PDF');
    const a = document.createElement('a'); a.href = `${url}#page=1`; a.target = '_blank'; a.textContent = name;
    const span = document.createElement('span'); span.className = 'sourceTag';
    const count = docKb.filter(x => x.pdfIndex === idx).length;
    span.innerHTML = `<span>📄</span>`; span.appendChild(a); span.insertAdjacentHTML('beforeend', `<span style="opacity:.7">(${count})</span>`);
    wrap.appendChild(span);
  });
}

// ===== Status / Progress helpers =====
function setStatus(text, ratio){
  const box = document.getElementById('loadStatus');
  const txt = document.getElementById('statusText');
  const fill = document.getElementById('statusFill');
  if (!box || !txt || !fill) return;
  box.classList.remove('hidden');
  txt.textContent = text;
  if (typeof ratio === 'number') {
    const pct = Math.max(0, Math.min(1, ratio)) * 100;
    fill.style.width = pct + '%';
  }
}
function clearStatus(){
  const box = document.getElementById('loadStatus');
  const fill = document.getElementById('statusFill');
  if (box) box.classList.add('hidden');
  if (fill) fill.style.width = '0%';
}

// Modal & toast
function showShareModal(appUrl, cacheUrl){
  lastShareAppUrl = appUrl;
  const m = document.getElementById('shareModal');
  document.getElementById('shareAppUrlInput').value = appUrl || '';
  document.getElementById('shareCacheUrlInput').value = cacheUrl || '';
  m.classList.remove('hidden');
}
function hideShareModal(){
  document.getElementById('shareModal').classList.add('hidden');
}
function toast(msg='Copied!'){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 1400);
}
async function copyToClipboard(text){
  try{
    await navigator.clipboard.writeText(text);
    toast();
  }catch(e){
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    toast();
  }
}

// Auto-expand textarea
const userInput = document.getElementById("userInput");
userInput.addEventListener("input", function(){
  this.style.height = "auto";
  this.style.height = this.scrollHeight + "px";
});

// ===== Query parsing: "question - Module" =====
function parseQueryParts(q){
  const m = q.split(/\s*[-–—:|]\s*/);
  if (m.length >= 2){
    const module = m[m.length - 1].trim();
    const keywords = m.slice(0, m.length - 1).join(' ').trim();
    return { keywords, module };
  }
  return { keywords: q.trim(), module: '' };
}
function pickModuleIndex(module){
  if (!module) return null;
  let bestIdx = null, bestScore = 0;
  const ml = module.toLowerCase();
  for (let i=0;i<pdfNames.length;i++){
    const nm = (pdfNames[i]||'').toLowerCase();
    const s = normalizedSimilarity(ml, nm);
    if (s > bestScore){ bestScore = s; bestIdx = i; }
  }
  return (bestScore >= 0.42) ? bestIdx : null;
}

// ===== Search (Excel KB + PDF, module narrows PDFs) =====
function levenshtein(a,b){if(!a||!b) return a||b?Math.max(a.length,b.length):0;const m=a.length,n=b.length,dp=Array(m+1).fill(0).map(()=>Array(n+1).fill(0));for(let i=0;i<=m;i++)dp[i][0]=i;for(let j=0;j<=n;j++)dp[0][j]=j;for(let i=1;i<=m;i++)for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1;dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+c);}return dp[m][n];}
function normalizedSimilarity(a,b){a=(a||"").toLowerCase();b=(b||"").toLowerCase();const d=levenshtein(a,b),M=Math.max(a.length,b.length);return M?1-d/M:1;}
function scoreMatch(q,t){return normalizedSimilarity(q,t);} 
function searchAll(query){
  const { keywords, module } = parseQueryParts(query);
  const words = keywords.toLowerCase().split(/\s+/).filter(w=>w.length>2);

  // PDF pool (respect module scope)
  let pdfPool = [...docKb];
  const modIdx = pickModuleIndex(module);
  if (modIdx !== null) pdfPool = pdfPool.filter(k => k.pdfIndex === modIdx);

  // Excel pool
  let kbPool = kb.map(text => ({ text, source:'KB' }));

  // If no keywords and only module given, show only PDFs
  let combined = (words.length === 0) ? pdfPool : [...pdfPool, ...kbPool];

  // Filter by keywords
  let candidates = words.length ? combined.filter(k => words.some(w => k.text.toLowerCase().includes(w))) : combined;

  const scored = candidates.map(k => {
      const qForScore = keywords || module || '';
      let score = scoreMatch(qForScore, k.text);
      if (k.source === 'PDF') score += 0.15;
      if (k.source === 'KB' && modIdx !== null) score -= 0.05;
      return { item:k, score };
    })
    .sort((a,b)=>b.score-a.score)
    .slice(0, 10);

  return { hits: scored, modIdx, keywords, module };
}
function composeReply(query){
  const { hits, modIdx, keywords, module } = searchAll(query);
  if(hits.length===0)return `No relevant info found.\nTip: Include a module after a dash, e.g. Interview Scheduling - Recruiting`;

  const scope = (modIdx !== null) ? (pdfNames[modIdx] || module || 'PDF') : (module ? module : 'All');

  let reply="Keyword & Module:\n\n| Keyword | Module |\n|---------|--------|\n| "+(keywords||'(none)')+" | "+scope+" |\n\n";
  reply+="Answers Found:\n\n| # | Snippet | Source |\n|---|----------|--------|\n";
  const regex = keywords ? new RegExp(`(${keywords})`,"ig") : null;
  hits.forEach((h,i)=>{
    let snippet=h.item.text.replace(/\n/g," ");
    if(snippet.length>220)snippet=snippet.slice(0,220)+"...";
    if (regex) snippet=snippet.replace(regex,"<mark>$1</mark>");
    let src;
    if(h.item.source==='KB'){
      src = 'Excel KB';
    } else {
      const web=pdfWebUrls[h.item.pdfIndex]||"";
      const label=(pdfNames[h.item.pdfIndex]||'PDF');
      src=web?`<a href="${web}#page=${h.item.page}" target="_blank">${label} p.${h.item.page}</a>`:`${label} p.${h.item.page}`;
    }
    reply+=`| ${i+1} | ${snippet} | ${src} |\n`;
  });
  return reply;
}

// ===== Graph helpers =====
async function gFetch(url,opt={}){
  const res=await fetch(url,opt);
  if(!res.ok){
    let t=""; try{t=await res.text();}catch{};
    throw new Error(`HTTP ${res.status} ${res.statusText}\n${t}`);
  }
  const ct=res.headers.get("content-type")||"";
  if(ct.includes("json"))return res.json();
  if(ct.includes("pdf")||ct.includes("octet"))return res.arrayBuffer();
  return res.text();
}
function toGraphShareId(url){let b=btoa(url).replace(/=+$/,'').replace(/\+/g,'-').replace(/\//g,'_');return 'u!'+b;}

// ===== OAuth =====
function loginMicrosoftGraph(){const tenant="common";const params=new URLSearchParams({client_id:clientId,response_type:"token",redirect_uri:redirectUri,scope:scopes,prompt:"select_account"});window.location.href=`https://login.microsoftonline.com/${tenant}/oauth2/v2.0/authorize?${params}`;}
function getTokenFromHash(){if(window.location.hash){const p=new URLSearchParams(window.location.hash.substring(1));const t=p.get("access_token");if(t){accessToken=t;window.location.hash="";enterAdminMode();}}}

// ===== OneDrive: resolve Excel (also capture parent folder) =====
async function resolveWorkbookContext(){
  if (workbookBase && driveId && parentFolderId) return;
  const shareId=toGraphShareId(shareLink);
  const item=await gFetch(`https://graph.microsoft.com/v1.0/shares/${shareId}/driveItem`,{headers:{Authorization:"Bearer "+accessToken}});
  driveId = item.parentReference.driveId;
  excelItemId = item.id;
  parentFolderId = item.parentReference.id; // folder id
  workbookBase  = `https://graph.microsoft.com/v1.0/drives/${driveId}/items/${excelItemId}/workbook`;
}

// ===== Excel + Config =====
async function readKnowledgeRows(){
  try{
    const tData = await gFetch(`${workbookBase}/tables`, { headers:{ Authorization:'Bearer '+accessToken } });
    const t = (tData.value||[]).find(x => (x.name||'').toLowerCase()==='knowledgetable');
    if (t){
      const rowsData = await gFetch(`${workbookBase}/tables('${t.name}')/rows`, { headers:{ Authorization:'Bearer '+accessToken } });
      return (rowsData.value||[]).map(r => (r.values && r.values[0] && r.values[0][0]) ? String(r.values[0][0]).trim() : "").filter(Boolean);
    }
  }catch(e){ /* fall back to range */ }
  try{
    const data=await gFetch(`${workbookBase}/worksheets('Knowledge')/range(address='A2:A20000')`,{headers:{Authorization:'Bearer '+accessToken}});
    const vals=Array.isArray(data.values)?data.values:[];
    return vals.map(r=>(r&&r[0]?String(r[0]).trim():"")).filter(Boolean);
  }catch(err){
    addChat("Bot","Error reading Knowledge: "+err.message);
    return [];
  }
}
async function readPdfLinksFromConfig(){
  let entries=[];
  try{
    const tData = await gFetch(`${workbookBase}/tables`, { headers:{ Authorization:'Bearer '+accessToken } });
    const t = (tData.value||[]).find x => (x.name||'').toLowerCase()==='configtable';
    if (t){
      const headerRes = await gFetch(`${workbookBase}/tables('${t.name}')/headerRowRange`, { headers:{ Authorization:'Bearer '+accessToken } });
      const headers = (headerRes.values && headerRes.values[0]) ? headerRes.values[0].map(v=>String(v).trim().toLowerCase()) : [];
      const nameIdx = headers.indexOf('name');
      const linkIdx = headers.indexOf('pdflink');
      const rowsData = await gFetch(`${workbookBase}/tables('${t.name}')/rows`, { headers:{ Authorization:'Bearer '+accessToken } });
      entries = (rowsData.value||[]).map(r => {
        const row = (r.values && r.values[0]) ? r.values[0] : [];
        const name = nameIdx>=0 ? String(row[nameIdx]||'').trim() : '';
        const link = linkIdx>=0 ? String(row[linkIdx]||'').trim() : '';
        return { name, link };
      }).filter(e => /^https?:\/\//i.test(e.link));
      if (entries.length) return entries;
    }
  }catch(e){ /* fall back to ranges */ }
  try{
    const data=await gFetch(`${workbookBase}/worksheets('Config')/range(address='A2:B200')`,{headers:{Authorization:'Bearer '+accessToken}});
    const vals=Array.isArray(data.values)?data.values:[];
    entries=vals.map(r=>({name:String(r[0]||"").trim(),link:String(r[1]||"").trim()})).filter(e=>/^https?:\/\//i.test(e.link));
    if(entries.length) return entries;
  }catch(e){ /* continue */ }
  try{
    const data=await gFetch(`${workbookBase}/worksheets('Config')/range(address='A2:A200')`,{headers:{Authorization:'Bearer '+accessToken}});
    const vals=Array.isArray(data.values)?data.values:[];
    entries=vals.map r=>({name:'',link:(r&&r[0]?String(r[0]).trim():"")}).filter(e=>/^https?:\/\//i.test(e.link));
  }catch(err){
    addChat("Bot","Config sheet missing or PDF links not found.");
  }
  return entries;
}

// ===== PDF: fetch & index (with progress) =====
async function fetchSinglePdfFromOneDrive(link, idx, label, onProgress){
  const shareId=toGraphShareId(link);
  const item=await gFetch(`https://graph.microsoft.com/v1.0/shares/${shareId}/driveItem`,{headers:{Authorization:"Bearer "+accessToken}});
  pdfWebUrls[idx]=item.webUrl; // may be tenant-only
  pdfItemIds[idx]=item.id;
  pdfDriveIds[idx]=item.parentReference.driveId;
  const buf=await gFetch(`https://graph.microsoft.com/v1.0/drives/${item.parentReference.driveId}/items/${item.id}/content`,{headers:{Authorization:'Bearer '+accessToken}});
  const pdf=await pdfjsLib.getDocument({data:buf}).promise;
  const totalPages = pdf.numPages;
  if (onProgress) onProgress(0, totalPages, label);
  let extracted=0;
  for(let p=1;p<=totalPages;p++){
    const page=await pdf.getPage(p);
    const tc=await page.getTextContent();
    const txt=tc.items.map(it=>it.str).join(" ").replace(/\s+/g," ").trim();
    const chunkSize=500, overlap=80;
    for(let i=0;i<txt.length;i+=(chunkSize-overlap)){
      const chunk=txt.slice(i,i+chunkSize).trim();
      if(chunk.length>60){
        docKb.push({text:chunk,source:'PDF',page:p,pdfIndex:idx});
        extracted++;
      }
    }
    if (onProgress) onProgress(p, totalPages, label);
  }
  addChat("Bot",`Parsed ${label || ('PDF '+(idx+1))}: ${extracted} chunks.`);
}

// ===== Build cache (Admin) =====
async function buildCacheFromOneDrive(){
  setStatus('Building cache: Reading workbook…', 0);
  await resolveWorkbookContext();
  const knowledgeTexts = await readKnowledgeRows();
  kb = knowledgeTexts;
  addChat("Bot","Excel KB loaded.");
  const pdfEntries = await readPdfLinksFromConfig();
  if (!pdfEntries.length){
    clearStatus();
    addChat("Bot","No PDFs configured in Excel Config sheet.");
    return;
  }
  setStatus('Opening PDFs…', 0);
  pdfWebUrls=[]; pdfNames=[]; docKb=[]; pdfItemIds=[]; pdfDriveIds=[];
  for(let idx=0; idx<pdfEntries.length; idx++){
    const {name,link}=pdfEntries[idx];
    pdfNames[idx] = name || 'PDF';
    try{
      await fetchSinglePdfFromOneDrive(link, idx, pdfNames[idx], (page,total,label)=>{
        const text = total ? `Scanning ${label}: ${page}/${total} page(s)…` : `Scanning ${label}…`;
        const ratio = total ? (page/total) : 0;
        setStatus(text, ratio);
      });
    }catch(e){
      addChat("Bot",`Error loading PDF ${idx+1}: ${e.message}`);
    }
  }
  clearStatus();
  renderSources();
  const total=docKb.length;
  document.getElementById("pdfCount").textContent=`PDF: ${total}`;
  document.getElementById("pdfCount").classList.remove("hidden");
  addChat("Bot",`Cache built: ${kb.length} KB rows, ${total} PDF chunks across ${pdfNames.length} PDF(s).`);
}

// ===== Publish cache JSON to OneDrive (Admin) =====
async function publishPublicCache(){
  if (!driveId || !parentFolderId) await resolveWorkbookContext();
  const makePublicCheckbox = document.getElementById('makePublicPdfs');
  const makePublic = !!makePublicCheckbox.checked;

  // Persist toggle choice
  try { localStorage.setItem(TOGGLE_KEY, makePublic ? '1' : '0'); } catch(e) {}

  let urlsForCache = [...pdfWebUrls];
  if (makePublic){
    addChat("Bot","Creating anonymous view links for each PDF…");
    for (let i=0;i<pdfItemIds.length;i++){
      try{
        const linkRes = await gFetch(`https://graph.microsoft.com/v1.0/drives/${pdfDriveIds[i]}/items/${pdfItemIds[i]}/createLink`, {
          method:'POST',
          headers:{ Authorization:'Bearer '+accessToken, 'Content-Type':'application/json' },
          body: JSON.stringify({ type:'view', scope:'anonymous' })
        });
        const viewUrl = linkRes && linkRes.link && linkRes.link.webUrl ? linkRes.link.webUrl : null;
        if (viewUrl) urlsForCache[i] = viewUrl;
      }catch(e){
        addChat("Bot", `Could not create anonymous link for “${pdfNames[i] || 'PDF '+(i+1)}”: ${e.message}`);
      }
    }
  }

  const cacheObj = { version:1, ts:Date.now(), kb, pdfNames, pdfWebUrls: urlsForCache, docKb };
  const body = JSON.stringify(cacheObj);

  // Find or create file
  let children = await gFetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${parentFolderId}/children?$select=id,name`, { headers:{ Authorization:'Bearer '+accessToken } });
  const existing = (children.value||[]).find(ch => (ch.name||'').toLowerCase() === PUBLIC_CACHE_NAME.toLowerCase());
  let item;
  if (existing){
    item = await gFetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${existing.id}/content`, {
      method:'PUT',
      headers:{ Authorization:'Bearer '+accessToken, 'Content-Type':'application/json' },
      body
    });
  }else{
    item = await gFetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${parentFolderId}:/${PUBLIC_CACHE_NAME}:/content`, {
      method:'PUT',
      headers:{ Authorization:'Bearer '+accessToken, 'Content-Type':'application/json' },
      body
    });
  }
  const itemId = (item.id || (existing && existing.id));
  // Public link for JSON
  const linkRes = await gFetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${itemId}/createLink`, {
    method:'POST',
    headers:{ Authorization:'Bearer '+accessToken, 'Content-Type':'application/json' },
    body: JSON.stringify({ type:'view', scope:'anonymous' })
  });
  let linkUrl = linkRes && linkRes.link && linkRes.link.webUrl ? linkRes.link.webUrl : (item.webUrl || '');
  let dlUrl = linkUrl ? (linkUrl.includes('?') ? (linkUrl + '&download=1') : (linkUrl + '?download=1')) : linkUrl;
  publicCacheUrl = dlUrl || linkUrl;
  localStorage.setItem('tmc_public_cache_url', publicCacheUrl);

  const shareAppUrl = location.origin + location.pathname + '?cache=' + encodeURIComponent(publicCacheUrl);

  const hint = document.getElementById('publicCacheHint');
  if (hint){
    const pdfNote = makePublic ? "<br>✓ PDF links were made public (anonymous view)." : "<br>ℹ︎ PDF links were left as tenant-only.";
    hint.innerHTML = `Shared JSON published.<br>Public cache: <a href="${publicCacheUrl}" target="_blank">open</a><br>Share this app URL with users: <a href="${shareAppUrl}" target="_blank">${shareAppUrl}</a>${pdfNote}`;
  }

  showShareModal(shareAppUrl, publicCacheUrl);
  document.getElementById('showShareBtn').classList.remove('hidden');
  addChat("Bot", `Published public cache JSON. Users can open: ${shareAppUrl}`);
}

// ===== User: load public cache (no login) =====
async function loadPublicCache(url){
  try{
    setStatus('Loading shared cache…', 0);
    const res = await fetch(url, { cache:'no-store' });
    const data = await res.json();
    kb = Array.isArray(data.kb) ? data.kb : [];
    pdfNames = Array.isArray(data.pdfNames) ? data.pdfNames : [];
    pdfWebUrls = Array.isArray(data.pdfWebUrls) ? data.pdfWebUrls : [];
    docKb = Array.isArray(data.docKb) ? data.docKb : [];
    clearStatus();
    renderSources();
    const total=docKb.length;
    const when = data.ts ? new Date(data.ts).toLocaleString() : 'unknown time';
    document.getElementById("pdfCount").textContent=`PDF: ${total}`;
    document.getElementById("pdfCount").classList.remove("hidden");
    addChat("Bot", `Loaded shared cache (${when}). Ready to search.`);
  }catch(err){
    clearStatus();
    addChat("Bot", "Failed to load public cache. Ensure the link is an anonymous share and supports direct download (?download=1). Error: " + err.message);
  }
}

// ===== Input handlers =====
async function handleInput(){
  const val=document.getElementById("userInput").value.trim();
  if(!val) return;
  document.getElementById("userInput").value="";
  document.getElementById("userInput").style.height="auto";
  addChat("User",val);
  addChat("Bot",composeReply(val));
}
document.getElementById("sendBtn").addEventListener("click", handleInput);
document.getElementById("userInput").addEventListener("keydown", e=>{ if(e.key==="Enter" && !e.shiftKey) { e.preventDefault(); handleInput(); } });

document.getElementById("adminToggleBtn").addEventListener("click", async ()=>{
  if (isAdmin){
    isAdmin=false; document.getElementById('modeLabel').textContent='User';
    document.getElementById('switchBtn').classList.add('hidden');
    document.getElementById('buildCacheBtn').classList.add('hidden');
    document.getElementById('publishCacheBtn').classList.add('hidden');
    document.getElementById('pubCacheBox').classList.add('hidden');
    document.getElementById('showShareBtn').classList.add('hidden');
    addChat("Bot","Switched to User mode.");
    return;
  }
  if (!accessToken){ addChat("Bot","Opening Microsoft sign-in…"); return loginMicrosoftGraph(); }
  await resolveWorkbookContext();
  isAdmin = true;
  document.getElementById('modeLabel').textContent='Admin';
  document.getElementById('switchBtn').classList.remove('hidden');
  document.getElementById('buildCacheBtn').classList.remove('hidden');
  document.getElementById('publishCacheBtn').classList.remove('hidden');
  document.getElementById('pubCacheBox').classList.remove('hidden');
  // Load persisted toggle (default ON if missing)
  try {
    const saved = localStorage.getItem(TOGGLE_KEY);
    const val = (saved === null) ? true : (saved === '1');
    document.getElementById('makePublicPdfs').checked = val;
  } catch(e){ document.getElementById('makePublicPdfs').checked = true; }
  addChat("Bot","Admin mode: 1) Build Cache, 2) (Optional) check “Make PDF links publicly viewable”, 3) Publish Public Cache, then share the app link with ?cache=…");
});
document.getElementById("switchBtn").addEventListener("click", ()=>{
  accessToken=null; workbookBase=null; driveId=null; parentFolderId=null; excelItemId=null;
  isAdmin=false; document.getElementById('modeLabel').textContent='User';
  document.getElementById('switchBtn').classList.add('hidden');
  document.getElementById('buildCacheBtn').classList.add('hidden');
  document.getElementById('publishCacheBtn').classList.add('hidden');
  document.getElementById('pubCacheBox').classList.add('hidden');
  document.getElementById('showShareBtn').classList.add('hidden');
  addChat("Bot","Switching account… redirecting to Microsoft sign-in.");
  loginMicrosoftGraph();
});
document.getElementById("buildCacheBtn").addEventListener("click", async ()=>{
  if (!accessToken) return addChat("Bot","Please Admin Login first.");
  await buildCacheFromOneDrive();
});
document.getElementById("publishCacheBtn").addEventListener("click", async ()=>{
  if (!accessToken) return addChat("Bot","Please Admin Login first.");
  if (!kb.length && !docKb.length) await buildCacheFromOneDrive();
  await publishPublicCache();
});
document.getElementById("savePublicCacheBtn").addEventListener("click", ()=>{
  const v = document.getElementById('publicCacheInput').value.trim();
  if (!v) return;
  localStorage.setItem('tmc_public_cache_url', v);
  publicCacheUrl = v;
  addChat("Bot","Saved public cache URL for this browser.");
});
document.getElementById("clearPublicCacheBtn").addEventListener("click", ()=>{
  localStorage.removeItem('tmc_public_cache_url');
  publicCacheUrl = null;
  addChat("Bot","Cleared saved public cache URL.");
});
document.getElementById("showShareBtn").addEventListener("click", ()=>{
  if (!publicCacheUrl) return addChat("Bot","No public cache URL available yet.");
  const appUrl = lastShareAppUrl || (location.origin + location.pathname + '?cache=' + encodeURIComponent(publicCacheUrl));
  showShareModal(appUrl, publicCacheUrl);
});
document.getElementById("copyAppUrlBtn").addEventListener("click", ()=>{
  const v = document.getElementById('shareAppUrlInput').value;
  if (v) copyToClipboard(v);
});
document.getElementById("copyCacheUrlBtn").addEventListener("click", ()=>{
  const v = document.getElementById('shareCacheUrlInput').value;
  if (v) copyToClipboard(v);
});
document.getElementById("closeShareModalBtn").addEventListener("click", hideShareModal);

// Persist toggle whenever changed
document.addEventListener('change', (e)=>{
  if (e.target && e.target.id === 'makePublicPdfs'){
    try { localStorage.setItem(TOGGLE_KEY, e.target.checked ? '1' : '0'); } catch(err){}
  }
});

// ===== OAuth capture =====
function enterAdminMode(){
  isAdmin = true;
  document.getElementById('modeLabel').textContent='Admin';
  document.getElementById('switchBtn').classList.remove('hidden');
  document.getElementById('buildCacheBtn').classList.remove('hidden');
  document.getElementById('publishCacheBtn').classList.remove('hidden');
  document.getElementById('pubCacheBox').classList.remove('hidden');
  // Load persisted toggle (default ON if missing)
  try {
    const saved = localStorage.getItem(TOGGLE_KEY);
    const val = (saved === null) ? true : (saved === '1');
    document.getElementById('makePublicPdfs').checked = val;
  } catch(e){ document.getElementById('makePublicPdfs').checked = true; }
  addChat("Bot","Logged in as Admin. Build and Publish cache to generate share links.");
}

// ===== Bootstrap (User mode first) =====
function init(){
  const usp = new URLSearchParams(location.search);
  if (usp.get('cache')){
    const url = decodeURIComponent(usp.get('cache'));
    localStorage.setItem('tmc_public_cache_url', url);
  }
  publicCacheUrl = localStorage.getItem('tmc_public_cache_url');
  if (publicCacheUrl){
    document.getElementById('publicCacheInput').value = publicCacheUrl;
    loadPublicCache(publicCacheUrl);
  } else {
    addChat("Bot","No public cache configured. Ask an admin to publish the cache, or paste the public JSON link then click “Use this link”.");
  }
  // Pre-set toggle default to ON even before admin mode; admin handlers will reapply persisted value
  try {
    const saved = localStorage.getItem(TOGGLE_KEY);
    const val = (saved === null) ? true : (saved === '1');
    document.getElementById('makePublicPdfs').checked = val;
  } catch(e){ document.getElementById('makePublicPdfs').checked = true; }
  getTokenFromHash();
}
init();
</script>
</body>
</html>
