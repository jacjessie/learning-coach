<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TALENT MODULE COACH â€” Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
<style>
  :root { --bg:#07102a; --card:#0b1220; --text:#e6eef8; --muted:#a9b8d9; --accent:#7c3aed; --line:#24305e; }
  *{box-sizing:border-box}
  body {font-family: Arial, system-ui, -apple-system; background:var(--bg); color:var(--text); margin:20px;}
  .card{background:var(--card);padding:14px;border-radius:14px;margin-bottom:20px;}
  h1{margin:0 0 6px 0;font-size:22px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start}
  .btn{background:var(--accent);border:none;padding:8px 12px;border-radius:10px;color:white;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
  .btn.secondary{background:#475569}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:#cfe0ff}
  .tag{display:inline-block;background:#1a2448;border:1px solid #24305e;border-radius:14px;padding:2px 8px;margin-left:6px;font-size:12px;opacity:.9}
  .badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:11px;margin-left:6px}
  .badge.public{background:#14532d;border:1px solid #166534;color:#bbf7d0}
  .badge.tenant{background:#3b0764;border:1px solid #581c87;color:#e9d5ff}
  .small{opacity:.85;font-size:12px}
  #chat{height:420px;overflow:auto;border:1px solid rgba(255,255,255,.08);padding:10px;border-radius:10px;background:rgba(255,255,255,.02)}
  .log{margin:6px 0;padding:8px;background:rgba(255,255,255,.03);border-radius:8px;font-size:13px}
  .sources{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .sourceTag{display:inline-flex;gap:6px;align-items:center;background:#0f1a3d;border:1px solid #22336b;border-radius:14px;padding:4px 8px}
  .sourceTag a{color:#cbd5ff;text-decoration:none}
  .status{display:flex;align-items:center;gap:10px;margin-top:8px}
  .spinner { width:14px; height:14px; border:2px solid rgba(255,255,255,0.25); border-top-color:#cbd5ff; border-radius:50%; animation:spin 0.9s linear infinite; }
  @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
  .bar { width:260px;height:6px;background:rgba(255,255,255,.15);border-radius:6px;overflow:hidden }
  .bar > span{display:block;height:100%;width:0%;background:var(--accent);transition:width .2s}
  .toggle{display:inline-flex;align-items:center;gap:8px;font-size:12px}
  .legend{display:flex;gap:10px;align-items:center;margin-top:6px;font-size:12px;opacity:.85}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
  .modal.show{display:flex}
  .box{background:var(--card);border:1px solid var(--line);padding:16px;border-radius:12px;min-width:320px;max-width:720px}
  .box .row{align-items:center}
  .box input{flex:1;background:#0b152d;border:1px solid #2a3a6c;color:#cfe0ff;border-radius:6px;padding:8px}
  .toast{position:fixed;right:16px;bottom:16px;background:#102247;border:1px solid #3756a1;color:#dbe6ff;padding:8px 12px;border-radius:8px;opacity:0;transform:translateY(8px);transition:.25s;z-index:60}
  .toast.show{opacity:1;transform:none}
  a.inline{color:#cbd5ff}
</style>
</head>
<body>
<div class="card">
  <h1>TALENT MODULE COACH â€” Admin</h1>
  <div class="small">Manage cache publishing from OneDrive (Excel + PDFs). Share the user URL once published.</div>
  <div class="row" style="margin-top:10px">
    <button id="loginBtn" class="btn">Admin Login</button>
    <a id="authHref" class="btn ghost" style="display:none" target="_self">Open Microsoft signâ€‘in</a>
    <button id="buildBtn" class="btn" disabled>Build Cache</button>
    <label class="toggle"><input type="checkbox" id="publicPdfsChk"> Make PDF links publicly viewable</label>
    <button id="publishBtn" class="btn" disabled>Publish Public Cache</button>
    <button id="switchBtn" class="btn secondary" disabled>Switch Account</button>
    <span id="pdfCount" class="tag" style="display:none">PDF: 0</span>
  </div>
  <div id="statusRow" class="status" style="display:none">
    <div class="spinner"></div><span id="statusText" class="small">Loadingâ€¦</span>
    <div class="bar"><span id="statusFill"></span></div>
  </div>
</div>

<div class="card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <div>
      <div class="small">Sources</div>
      <div class="legend">
        <span>Legend:</span>
        <span class="badge public">Public</span>
        <span class="badge tenant">Tenant-only</span>
      </div>
    </div>
    <div id="sources" class="sources"></div>
  </div>
  <div id="chat"></div>
</div>

<!-- Share Modal -->
<div id="shareModal" class="modal" role="dialog" aria-modal="true">
  <div class="box">
    <h3 style="margin:0 0 10px 0">Share this app</h3>
    <div class="row">
      <label style="min-width:110px" class="small">App URL</label>
      <input id="shareAppUrl" readonly>
      <button id="copyApp" class="btn">Copy</button>
    </div>
    <div class="row" style="margin-top:8px">
      <label style="min-width:110px" class="small">Cache JSON</label>
      <input id="shareCacheUrl" readonly>
      <button id="copyCache" class="btn">Copy</button>
    </div>
    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button id="closeShare" class="btn secondary">Close</button>
    </div>
  </div>
</div>
<div id="toast" class="toast">Copied!</div>

<script>
// ===== CONFIG =====
const clientId    = "7f3c8426-3ef5-4e28-acf0-5f51224bc0a6";
const redirectUri = "https://jacjessie.github.io/learning-coach/tmc_admin.html"; // IMPORTANT: host path of this admin page
const scopes      = "Files.ReadWrite.All User.Read";
const shareLink   = "https://xvxky-my.sharepoint.com/:x:/g/personal/jacjessie_xvxky_onmicrosoft_com/Ef4Mr6_ZWd1Dm0D6mAe2ffkBI4syJuD6xhj-ekpItxdyXw?e=8VIx5C";
const PUBLIC_CACHE_NAME = "tmcoach_cache.json";
const TOGGLE_KEY = "tmc_make_public_pdfs";

// ===== STATE =====
let accessToken=null, workbookBase=null, driveId=null, excelItemId=null, parentFolderId=null;
let kb=[], docKb=[], pdfNames=[], pdfWebUrls=[], pdfItemIds=[], pdfDriveIds=[], pdfPublicFlags=[];
let publicCacheUrl=null;

// ===== UI helpers =====
const chat = document.getElementById('chat');
function log(msg){ const d=document.createElement('div'); d.className='log'; d.innerHTML=msg; chat.appendChild(d); chat.scrollTop=chat.scrollHeight; }
function setStatus(text, ratio){
  const row=document.getElementById('statusRow'); const t=document.getElementById('statusText'); const f=document.getElementById('statusFill');
  row.style.display='flex'; t.textContent=text; if(typeof ratio==='number'){ f.style.width=(Math.max(0,Math.min(1,ratio))*100)+'%'; }
}
function clearStatus(){ document.getElementById('statusRow').style.display='none'; document.getElementById('statusFill').style.width='0%'; }
function toast(msg='Copied!'){ const el=document.getElementById('toast'); el.textContent=msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'),1300); }
async function copy(v){ try{ await navigator.clipboard.writeText(v); toast(); }catch(e){ const ta=document.createElement('textarea'); ta.value=v; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); toast(); } }
function renderSources(){
  const wrap=document.getElementById('sources'); wrap.innerHTML='';
  pdfWebUrls.forEach((u,i)=>{
    const s=document.createElement('span'); s.className='sourceTag';
    const badge = `<span class="badge ${pdfPublicFlags[i] ? 'public' : 'tenant'}">${pdfPublicFlags[i] ? 'Public' : 'Tenant-only'}</span>`;
    s.innerHTML=`<span>ðŸ“„</span><a href="${u}#page=1" target="_blank">${pdfNames[i]||'PDF'}</a>${badge}<span class="small" style="opacity:.7">(${docKb.filter(x=>x.pdfIndex===i).length})</span>`;
    wrap.appendChild(s);
  });
}

// ===== Auth =====
function authUrl(){
  const tenant="common"; const p=new URLSearchParams({client_id:clientId,response_type:"token",redirect_uri:redirectUri,scope:scopes,prompt:"select_account"});
  return `https://login.microsoftonline.com/${tenant}/oauth2/v2.0/authorize?${p}`;
}
function login(){
  const href=document.getElementById('authHref'); const url=authUrl(); href.href=url; href.style.display='inline-flex';
  log(`Opening Microsoft sign-inâ€¦ If blocked, <a class="inline" href="${url}" target="_self">click here</a>.`);
  window.location.assign(url);
}
function captureToken(){
  if(location.hash){
    const p=new URLSearchParams(location.hash.substring(1));
    const t=p.get('access_token'); if(t){ accessToken=t; location.hash=''; afterLogin(); }
  }
}
async function afterLogin(){
  document.getElementById('loginBtn').disabled=true;
  document.getElementById('switchBtn').disabled=false;
  document.getElementById('buildBtn').disabled=false;
  log('Signed in. You can Build Cache then Publish.');
  await resolveWorkbookContext();
}

// ===== Graph helpers =====
async function gFetch(url,opt={}){
  const res=await fetch(url,opt);
  if(!res.ok){ let t=""; try{t=await res.text();}catch{}; throw new Error(`HTTP ${res.status} ${res.statusText}\n${t}`); }
  const ct=res.headers.get("content-type")||"";
  if(ct.includes("json"))return res.json();
  if(ct.includes("pdf")||ct.includes("octet"))return res.arrayBuffer();
  return res.text();
}
function toShareId(url){ let b=btoa(url).replace(/=+$/,'').replace(/\+/g,'-').replace(/\//g,'_'); return 'u!'+b; }

// ===== Resolve Excel & parent folder =====
async function resolveWorkbookContext(){
  if(workbookBase && driveId && parentFolderId) return;
  const shareId=toShareId(shareLink);
  const item=await gFetch(`https://graph.microsoft.com/v1.0/shares/${shareId}/driveItem`,{headers:{Authorization:'Bearer '+accessToken}});
  driveId=item.parentReference.driveId; excelItemId=item.id; parentFolderId=item.parentReference.id;
  workbookBase=`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${excelItemId}/workbook`;
}

// ===== Read Excel =====
async function readKnowledgeRows(){
  try{
    const tData=await gFetch(`${workbookBase}/tables`,{headers:{Authorization:'Bearer '+accessToken}});
    const t=(tData.value||[]).find(x=>(x.name||'').toLowerCase()==='knowledgetable');
    if(t){
      const rows=await gFetch(`${workbookBase}/tables('${t.name}')/rows`,{headers:{Authorization:'Bearer '+accessToken}});
      return (rows.value||[]).map(r=>(r.values&&r.values[0]&&r.values[0][0])?String(r.values[0][0]).trim():"").filter(Boolean);
    }
  }catch(e){}
  try{
    const r=await gFetch(`${workbookBase}/worksheets('Knowledge')/range(address='A2:A20000')`,{headers:{Authorization:'Bearer '+accessToken}});
    const vals=Array.isArray(r.values)?r.values:[];
    return vals.map(x=>(x&&x[0]?String(x[0]).trim():"")).filter(Boolean);
  }catch(e){ log('Error reading Knowledge: '+e.message); return []; }
}
async function readPdfLinksFromConfig(){
  let entries=[];
  try{
    const tData=await gFetch(`${workbookBase}/tables`,{headers:{Authorization:'Bearer '+accessToken}});
    const t=(tData.value||[]).find(x=>(x.name||'').toLowerCase()==='configtable');
    if(t){
      const header=await gFetch(`${workbookBase}/tables('${t.name}')/headerRowRange`,{headers:{Authorization:'Bearer '+accessToken}});
      const heads=(header.values&&header.values[0])?header.values[0].map(v=>String(v).trim().toLowerCase()):[];
      const iName=heads.indexOf('name'), iLink=heads.indexOf('pdflink');
      const rows=await gFetch(`${workbookBase}/tables('${t.name}')/rows`,{headers:{Authorization:'Bearer '+accessToken}});
      entries=(rows.value||[]).map(r=>{ const v=(r.values&&r.values[0])?r.values[0]:[]; return {name:iName>=0?String(v[iName]||'').trim():'', link:iLink>=0?String(v[iLink]||'').trim():''}; }).filter(e=>/^https?:\/\//i.test(e.link));
      if(entries.length) return entries;
    }
  }catch(e){}
  try{
    const r=await gFetch(`${workbookBase}/worksheets('Config')/range(address='A2:B200')`,{headers:{Authorization:'Bearer '+accessToken}});
    const vals=Array.isArray(r.values)?r.values:[];
    entries=vals.map(v=>({name:String(v[0]||'').trim(),link:String(v[1]||'').trim()})).filter(e=>/^https?:\/\//i.test(e.link));
    if(entries.length) return entries;
  }catch(e){}
  try{
    const r=await gFetch(`${workbookBase}/worksheets('Config')/range(address='A2:A200')`,{headers:{Authorization:'Bearer '+accessToken}});
    const vals=Array.isArray(r.values)?r.values:[];
    entries=vals.map(v=>({name:'',link:(v&&v[0]?String(v[0]).trim():'')})).filter(e=>/^https?:\/\//i.test(e.link));
  }catch(e){ log('Config missing: '+e.message); }
  return entries;
}

// ===== PDF fetch & index =====
async function fetchSinglePdf(link, idx, label, onProgress){
  const sid=toShareId(link);
  const item=await gFetch(`https://graph.microsoft.com/v1.0/shares/${sid}/driveItem`,{headers:{Authorization:'Bearer '+accessToken}});
  pdfWebUrls[idx]=item.webUrl; pdfItemIds[idx]=item.id; pdfDriveIds[idx]=item.parentReference.driveId;
  const buf=await gFetch(`https://graph.microsoft.com/v1.0/drives/${item.parentReference.driveId}/items/${item.id}/content`,{headers:{Authorization:'Bearer '+accessToken}});
  const pdf=await pdfjsLib.getDocument({data:buf}).promise;
  const total=pdf.numPages; onProgress?.(0,total,label);
  let extracted=0;
  for(let p=1;p<=total;p++){
    const page=await pdf.getPage(p); const tc=await page.getTextContent();
    const txt=tc.items.map(it=>it.str).join(" ").replace(/\s+/g," ").trim();
    const size=500, overlap=80;
    for(let i=0;i<txt.length;i+=(size-overlap)){
      const chunk=txt.slice(i,i+size).trim(); if(chunk.length>60){ docKb.push({text:chunk,source:'PDF',page:p,pdfIndex:idx}); extracted++; }
    }
    onProgress?.(p,total,label);
  }
  log(`Parsed ${label||('PDF '+(idx+1))}: ${extracted} chunks.`);
}

// ===== Build & Publish =====
async function buildCache(){
  setStatus('Reading workbookâ€¦',0);
  await resolveWorkbookContext();
  kb=await readKnowledgeRows(); log('Excel KB loaded. Rows: '+kb.length);
  const pdfs=await readPdfLinksFromConfig();
  if(!pdfs.length){ clearStatus(); log('No PDFs configured in Config sheet.'); return; }
  pdfNames=[]; pdfWebUrls=[]; pdfItemIds=[]; pdfDriveIds=[]; docKb=[]; pdfPublicFlags=[];
  for(let i=0;i<pdfs.length;i++){
    const {name,link}=pdfs[i]; pdfNames[i]=name||'PDF'; pdfPublicFlags[i]=false;
    try{
      await fetchSinglePdf(link,i,pdfNames[i],(page,total,label)=>{ setStatus(`Scanning ${label}: ${page}/${total}â€¦`, total? page/total: 0); });
    }catch(e){ log(`Error reading PDF ${i+1}: ${e.message}`); }
  }
  clearStatus();
  renderSources();
  document.getElementById('pdfCount').style.display='inline-block';
  document.getElementById('pdfCount').textContent='PDF: '+docKb.length;
  log(`Cache built in memory. KB rows=${kb.length}, PDF chunks=${docKb.length}, PDFs=${pdfNames.length}.`);
}
async function publishCache(){
  const makePublic = document.getElementById('publicPdfsChk').checked;
  try{ localStorage.setItem(TOGGLE_KEY, makePublic?'1':'0'); }catch(e){}
  setStatus('Publishing cache JSONâ€¦', .2);
  // Optionally public-ize PDFs
  let urlsForCache=[...pdfWebUrls];
  let flags=[...pdfPublicFlags];
  if(makePublic){
    log('Creating anonymous view links for PDFsâ€¦');
    for(let i=0;i<pdfItemIds.length;i++){
      try{
        const res=await gFetch(`https://graph.microsoft.com/v1.0/drives/${pdfDriveIds[i]}/items/${pdfItemIds[i]}/createLink`,{
          method:'POST',headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'},body:JSON.stringify({type:'view',scope:'anonymous'})});
        const u=res?.link?.webUrl; if(u) { urlsForCache[i]=u; flags[i]=true; }
      }catch(e){ log(`Could not make public link for ${pdfNames[i]||('PDF '+(i+1))}: ${e.message}`); flags[i]=false; }
    }
  }
  const cacheObj={version:1, ts:Date.now(), kb, pdfNames, pdfWebUrls:urlsForCache, pdfPublicFlags:flags, docKb};
  const body=JSON.stringify(cacheObj);
  await resolveWorkbookContext();
  // Upsert tmcoach_cache.json in same folder
  let children=await gFetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${parentFolderId}/children?$select=id,name`,{headers:{Authorization:'Bearer '+accessToken}});
  const exist=(children.value||[]).find(ch=>(ch.name||'').toLowerCase()===PUBLIC_CACHE_NAME.toLowerCase());
  let item;
  if(exist){
    item=await gFetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${exist.id}/content`,{method:'PUT',headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'},body});
  }else{
    item=await gFetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${parentFolderId}:/${PUBLIC_CACHE_NAME}:/content`,{method:'PUT',headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'},body});
  }
  const itemId=item.id || exist?.id;
  const link=await gFetch(`https://graph.microsoft.com/v1.0/drives/${driveId}/items/${itemId}/createLink`,{method:'POST',headers:{Authorization:'Bearer '+accessToken,'Content-Type':'application/json'},body:JSON.stringify({type:'view',scope:'anonymous'})});
  let linkUrl = link?.link?.webUrl || item.webUrl || '';
  let dl = linkUrl ? (linkUrl.includes('?')?linkUrl+'&download=1':linkUrl+'?download=1') : linkUrl;
  publicCacheUrl = dl || linkUrl;
  clearStatus();
  log(`Published cache. Public JSON: <a class="inline" href="${publicCacheUrl}" target="_blank">open</a>`);
  const appUrl = location.origin + location.pathname.replace('tmc_admin.html','tmc_user.html') + '?cache=' + encodeURIComponent(publicCacheUrl);
  showShare(appUrl, publicCacheUrl);
  // Update sources badges according to flags we actually published
  pdfPublicFlags = flags; renderSources();
}
function showShare(app, cache){ document.getElementById('shareAppUrl').value=app; document.getElementById('shareCacheUrl').value=cache; document.getElementById('shareModal').classList.add('show'); }
function hideShare(){ document.getElementById('shareModal').classList.remove('show'); }

// ===== Handlers =====
document.getElementById('loginBtn').onclick = login;
document.getElementById('switchBtn').onclick = ()=>{ accessToken=null; workbookBase=null; driveId=null; parentFolderId=null; excelItemId=null; location.assign(authUrl()); };
document.getElementById('buildBtn').onclick = buildCache;
document.getElementById('publishBtn').onclick = publishCache;
document.getElementById('copyApp').onclick = ()=>copy(document.getElementById('shareAppUrl').value);
document.getElementById('copyCache').onclick = ()=>copy(document.getElementById('shareCacheUrl').value);
document.getElementById('closeShare').onclick = hideShare;

// Default toggle = ON, then restore last choice
(function(){ try{ const saved=localStorage.getItem(TOGGLE_KEY); document.getElementById('publicPdfsChk').checked = (saved===null)?true:(saved==='1'); }catch(e){ document.getElementById('publicPdfsChk').checked = true; } })();

// Enable buttons when logged in
window.addEventListener('load', ()=>{
  captureToken();
  if(accessToken){ document.getElementById('buildBtn').disabled=false; document.getElementById('publishBtn').disabled=false; document.getElementById('switchBtn').disabled=false; }
});
</script>
</body>
</html>
