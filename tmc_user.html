<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>TALENT MODULE COACH â€” User</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!-- jsPDF for Export to PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<style>
  :root { --bg:#07102a; --card:#0b1220; --text:#e6eef8; --muted:#a9b8d9; --accent:#7c3aed; --line:#24305e; }
  *{box-sizing:border-box}
  body {font-family: Arial, system-ui, -apple-system; background:var(--bg); color:var(--text); margin:20px;}
  .card{background:var(--card);padding:14px;border-radius:14px;margin-bottom:20px;}
  h1{margin:0;font-size:22px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-start}
  .btn{background:var(--accent);border:none;padding:8px 12px;border-radius:10px;color:white;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
  #chat{height:420px;overflow:auto;border:1px solid rgba(255,255,255,.08);padding:10px;border-radius:10px;background:rgba(255,255,255,.02)}
  .msg{margin:6px 0;padding:8px;border-radius:8px;max-width:80%;white-space:pre-wrap}
  .user{background:rgba(99,102,241,0.15);align-self:flex-end}
  .bot{background:rgba(255,255,255,0.03);align-self:flex-start}
  .controls{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;align-items:flex-start}
  .notice{background:#13213d;border:1px solid #23386b;color:#cfe0ff;padding:6px 10px;border-radius:8px;margin-bottom:6px;font-size:12px;display:flex;align-items:center;gap:8px;}
  .notice::before{content:'âš ï¸';}
  textarea{width:100%;min-width:280px;font-family:inherit;line-height:1.4;resize:none;overflow:hidden}
  .chatTable{border-collapse:collapse;margin:6px 0;width:100%;font-size:13px;}
  .chatTable th,.chatTable td{border:1px solid rgba(255,255,255,0.2);padding:4px 6px;}
  .chatTable th{background:rgba(255,255,255,0.1);font-weight:bold;}
  mark{background:#facc15;color:#000;padding:0 2px;border-radius:2px;}
  .sources{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .sourceTag{display:inline-flex;gap:6px;align-items:center;background:#0f1a3d;border:1px solid #22336b;border-radius:14px;padding:4px 8px}
  .sourceTag a{color:#cbd5ff;text-decoration:none}
  .badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:11px;margin-left:6px}
  .badge.public{background:#14532d;border:1px solid #166534;color:#bbf7d0}
  .status{display:flex;align-items:center;gap:10px;margin-top:8px}
  .spinner { width:14px; height:14px; border:2px solid rgba(255,255,255,0.25); border-top-color:#cbd5ff; border-radius:50%; animation:spin 0.9s linear infinite; }
  @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
  .bar { width:260px;height:6px;background:rgba(255,255,255,.15);border-radius:6px;overflow:hidden }
  .bar > span{display:block;height:100%;width:0%;background:var(--accent);transition:width .2s}
  .pubbox{background:#0d1934;border:1px dashed #33447a;border-radius:8px;padding:8px;color:#cfe0ff;font-size:12px;margin-top:6px}
  .pubbox input{width:100%;background:#0b152d;border:1px solid #2a3a6c;color:#cfe0ff;border-radius:6px;padding:6px 8px;margin-top:6px}
  .muted{opacity:.8}
</style>
</head>
<body>
<div class="card">
  <h1 style="display:flex;align-items:center;gap:10px">
    TALENT MODULE COACH â€” User
    <span id="lastPub" class="muted" style="font-size:12px"></span>
  </h1>
  <div class="row" style="align-items:center;margin-top:6px">
    <div>Mode: <strong>User</strong></div>
    <div class="sources" id="sources"></div>
  </div>
</div>

<div class="card">
  <div id="chat"></div>
  <div class="controls">
    <div style="flex:1;min-width:280px">
      <div class="notice">Always review TMCoachâ€™s answers and never enter PII.</div>
      <textarea id="userInput" placeholder="Ask question + include the module. Ex. Interview Scheduling - Recruiting" rows="1"></textarea>
      <div id="pubCacheBox" class="pubbox" style="display:none">
        <div><strong>Public cache link</strong> (from your admin):</div>
        <input id="publicCacheInput" placeholder="Paste public JSON link here (ends with .json or ?download=1)">
        <div style="display:flex;gap:6px;margin-top:6px">
          <button id="useCache" class="btn">Use this link</button>
          <button id="clearCache" class="btn" style="background:#475569">Clear</button>
        </div>
        <div class="small" id="cacheHint" style="margin-top:6px;opacity:.8"></div>
      </div>
    </div>
    <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
      <button id="sendBtn" class="btn">Send</button>
      <div style="display:flex;gap:8px">
        <button id="exportPdfBtn" class="btn" disabled>Export results to PDF</button>
        <button id="copyCsvBtn" class="btn" style="background:#475569" disabled>Copy results (CSV)</button>
      </div>
      <span id="pdfCount" class="tag" style="display:none;margin-left:8px">PDF: 0</span>
    </div>
  </div>
  <div id="statusRow" class="status" style="display:none">
    <div class="spinner"></div><span id="statusText" class="small">Loadingâ€¦</span>
    <div class="bar"><span id="statusFill"></span></div>
  </div>
</div>

<script>
// ===== STATE =====
let kb=[], docKb=[], pdfNames=[], pdfWebUrls=[], pdfPublicFlags=[];
let lastHits=[], lastQuery="", lastModule="", lastKeywords="";
let lastPublishedTS = null;

// ===== UI =====
const chat=document.getElementById('chat');
function addChat(sender, html){ const d=document.createElement('div'); d.className='msg '+(sender==='User'?'user':'bot'); d.innerHTML=(sender==='User'?'You: ':'Bot:<br>')+markdownToTable(html); chat.appendChild(d); chat.scrollTop=chat.scrollHeight; }
function markdownToTable(md){
  const blocks=(md||'').split(/\\n\\s*\\n/);
  return blocks.map(b=>{
    if(/^\\s*\\|.*\\|\\s*$/m.test(b)){
      const rows=b.trim().split('\\n');
      return "<table class='chatTable'>"+rows.map((r,i)=>{const cols=r.trim().split('|').slice(1,-1).map(c=>c.trim()); const tag=(i===0)?'th':'td'; if(i===1 && /^-+$/.test(cols[0])) return ''; return '<tr>'+cols.map(c=>`<${tag}>${c}</${tag}>`).join('')+'</tr>';}).join('')+"</table>";
    }
    return '<p>'+b+'</p>';
  }).join('');
}
function setStatus(text, ratio){ const row=document.getElementById('statusRow'); const t=document.getElementById('statusText'); const f=document.getElementById('statusFill'); row.style.display='flex'; t.textContent=text; if(typeof ratio==='number'){ f.style.width=(Math.max(0,Math.min(1,ratio))*100)+'%'; } }
function clearStatus(){ document.getElementById('statusRow').style.display='none'; document.getElementById('statusFill').style.width='0%'; }
function renderSources(){
  const wrap=document.getElementById('sources'); wrap.innerHTML='';
  pdfWebUrls.forEach((u,i)=>{
    const s=document.createElement('span'); s.className='sourceTag';
    // Only show PUBLIC badge to users; hide tenant-only
    const badge = (pdfPublicFlags[i]) ? `<span class="badge public">Public</span>` : '';
    s.innerHTML=`<span>ðŸ“„</span><a href="${u}#page=1" target="_blank">${pdfNames[i]||'PDF'}</a>${badge}<span class="small" style="opacity:.7">(${docKb.filter(x=>x.pdfIndex===i).length})</span>`;
    wrap.appendChild(s);
  });
}
const userInput=document.getElementById('userInput'); userInput.addEventListener('input', function(){ this.style.height='auto'; this.style.height=this.scrollHeight+'px'; });

// ===== Search helpers =====
function levenshtein(a,b){if(!a||!b) return a||b?Math.max(a.length,b.length):0;const m=a.length,n=b.length,dp=Array(m+1).fill(0).map(()=>Array(n+1).fill(0));for(let i=0;i<=m;i++)dp[i][0]=i;for(let j=0;j<=n;j++)dp[0][j]=j;for(let i=1;i<=m;i++)for(let j=1;j<=n;j++){const c=a[i-1]===b[j-1]?0:1;dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+c);}return dp[m][n];}
function normalizedSimilarity(a,b){a=(a||'').toLowerCase();b=(b||'').toLowerCase();const d=levenshtein(a,b),M=Math.max(a.length,b.length);return M?1-d/M:1;}
function scoreMatch(q,t){return normalizedSimilarity(q,t);} 
function parseQueryParts(q){ const m=q.split(/\\s*[-â€“â€”:|]\\s*/); if(m.length>=2){ const module=m[m.length-1].trim(); const keywords=m.slice(0,m.length-1).join(' ').trim(); return {keywords,module}; } return {keywords:q.trim(),module:''}; }
function pickModuleIndex(module){ if(!module) return null; let best=-1,score=0; const ml=module.toLowerCase(); for(let i=0;i<pdfNames.length;i++){ const s=normalizedSimilarity(ml,(pdfNames[i]||'').toLowerCase()); if(s>score){score=s;best=i;} } return (score>=0.42)?best:null; }

function searchAll(query){
  const {keywords,module}=parseQueryParts(query);
  const words=keywords.toLowerCase().split(/\\s+/).filter(w=>w.length>2);
  let pdfPool=[...docKb]; const modIdx=pickModuleIndex(module); if(modIdx!==null) pdfPool=pdfPool.filter(k=>k.pdfIndex===modIdx);
  let kbPool=kb.map(text=>({text,source:'KB'}));
  let combined=(words.length===0)?pdfPool:[...pdfPool,...kbPool];
  let candidates=words.length?combined.filter(k=>words.some(w=>k.text.toLowerCase().includes(w))):combined;
  const scored=candidates.map(k=>{ const q=keywords||module||''; let s=scoreMatch(q,k.text); if(k.source==='PDF') s+=0.15; if(k.source==='KB' && modIdx!==null) s-=0.05; return {item:k,score:s}; }).sort((a,b)=>b.score-a.score).slice(0,10);
  return {hits:scored,modIdx,keywords,module};
}
function composeReply(query){
  const {hits,modIdx,keywords,module}=searchAll(query);
  lastHits = hits; lastQuery = query; lastKeywords = keywords; lastModule = (modIdx!==null)?(pdfNames[modIdx]||module||'PDF'):(module?module:'All');
  document.getElementById('exportPdfBtn').disabled = (hits.length===0);
  document.getElementById('copyCsvBtn').disabled = (hits.length===0);
  if(hits.length===0) return 'No relevant info found.\\nTip: Include a module after a dash, e.g. Interview Scheduling - Recruiting';
  const scope=lastModule;
  let out='Keyword & Module:\\n\\n| Keyword | Module |\\n|---------|--------|\\n| '+(keywords||'(none)')+' | '+scope+' |\\n\\n';
  out+='Answers Found:\\n\\n| # | Snippet | Source |\\n|---|----------|--------|\\n';
  const regex=keywords?new RegExp('('+keywords+')','ig'):null;
  hits.forEach((h,i)=>{ let sn=h.item.text.replace(/\\n/g,' '); if(sn.length>220) sn=sn.slice(0,220)+'...'; if(regex) sn=sn.replace(regex,'<mark>$1</mark>'); let src; if(h.item.source==='KB'){ src='Excel KB'; } else { const web=pdfWebUrls[h.item.pdfIndex]||''; const label=(pdfNames[h.item.pdfIndex]||'PDF'); src=web?`<a href="${web}#page=${h.item.page}" target="_blank">${label} p.${h.item.page}</a>`:`${label} p.${h.item.page}`; } out+=`| ${i+1} | ${sn} | ${src} |\\n`; });
  return out;
}

// ===== Export results to PDF =====
async function exportResultsToPDF(){
  if (!lastHits || lastHits.length===0) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  const pageWidth = doc.internal.pageSize.getWidth();
  const margin = 40;

  doc.setFont('helvetica','bold'); doc.setFontSize(14);
  doc.text('TALENT MODULE COACH â€” Search Results', margin, 40);
  doc.setFont('helvetica','normal'); doc.setFontSize(11);
  const now = new Date().toLocaleString();
  doc.text(`Query: ${lastQuery}`, margin, 60);
  doc.text(`Module: ${lastModule}`, margin, 76);
  if(lastPublishedTS){ doc.text(`Cache published: ${new Date(lastPublishedTS).toLocaleString()}`, margin, 92); }
  else { doc.text(`Cache published: (unknown)`, margin, 92); }

  const rows = lastHits.map((h,i)=>{
    const label = (h.item.source==='KB') ? 'Excel KB' : `${pdfNames[h.item.pdfIndex]||'PDF'} p.${h.item.page}`;
    const snippet = (h.item.text||'').replace(/\\s+/g,' ').slice(0,1000);
    return [String(i+1), snippet, label];
  });

  doc.autoTable({
    startY: 110,
    head: [['#','Snippet','Source']],
    body: rows,
    styles: { fontSize: 9, cellPadding: 6, overflow: 'linebreak' },
    columnStyles: {
      0: { cellWidth: 30 },
      1: { cellWidth: pageWidth - margin*2 - 200 },
      2: { cellWidth: 170 }
    },
    headStyles: { fillColor: [124,58,237] }
  });

  doc.save('tmcoach_results.pdf');
}

// ===== Copy results as CSV =====
function copyResultsAsCSV(){
  if (!lastHits || lastHits.length===0) return;
  const esc = (s)=>(''+s).replace(/"/g,'""');
  const rows = [['#','Snippet','Source']];
  lastHits.forEach((h,i)=>{
    const label = (h.item.source==='KB') ? 'Excel KB' : `${pdfNames[h.item.pdfIndex]||'PDF'} p.${h.item.page}`;
    const snippet = (h.item.text||'').replace(/\\s+/g,' ');
    rows.push([String(i+1), snippet, label]);
  });
  const csv = rows.map(r=>r.map(c=>`"${esc(c)}"`).join(',')).join('\\n');

  // Copy to clipboard
  const ta = document.createElement('textarea');
  ta.value = csv;
  document.body.appendChild(ta);
  ta.select();
  document.execCommand('copy');
  document.body.removeChild(ta);

  // Also trigger a lightweight download for convenience
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'tmcoach_results.csv';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url), 2000);
}

// ===== Cache loading =====
async function loadPublicCache(url){
  try{
    setStatus('Loading shared cacheâ€¦',0.2);
    const res=await fetch(url,{cache:'no-store'});
    const data=await res.json();
    kb=Array.isArray(data.kb)?data.kb:[];
    pdfNames=Array.isArray(data.pdfNames)?data.pdfNames:[];
    pdfWebUrls=Array.isArray(data.pdfWebUrls)?data.pdfWebUrls:[];
    pdfPublicFlags=Array.isArray(data.pdfPublicFlags)?data.pdfPublicFlags: new Array(pdfWebUrls.length).fill(false);
    docKb=Array.isArray(data.docKb)?data.docKb:[];
    lastPublishedTS = data.ts || null;
    clearStatus(); renderSources();
    const when=data.ts?new Date(data.ts).toLocaleString():'unknown time';
    document.getElementById('pdfCount').style.display='inline-block';
    document.getElementById('pdfCount').textContent='PDF: '+docKb.length;
    const lastPub = document.getElementById('lastPub'); lastPub.textContent = `Last published: ${when}`;
    addChat('Bot',`Loaded shared cache (${when}). Ready to search.`);
  }catch(err){
    clearStatus();
    addChat('Bot','Failed to load public cache. Paste a valid anonymous JSON link (try ?download=1). Error: '+err.message);
  }
}

// ===== Handlers =====
async function handleSend(){
  const v=document.getElementById('userInput').value.trim(); if(!v) return;
  document.getElementById('userInput').value=''; document.getElementById('userInput').style.height='auto'; addChat('User',v); addChat('Bot',composeReply(v));
}
document.getElementById('sendBtn').onclick=handleSend;
document.getElementById('userInput').addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); handleSend(); } });
document.getElementById('useCache').onclick=()=>{ const v=document.getElementById('publicCacheInput').value.trim(); if(!v) return; localStorage.setItem('tmc_public_cache_url',v); addChat('Bot','Saved cache URL.'); loadPublicCache(v); };
document.getElementById('clearCache').onclick=()=>{ localStorage.removeItem('tmc_public_cache_url'); addChat('Bot','Cleared saved cache URL.'); };
document.getElementById('exportPdfBtn').onclick=exportResultsToPDF;
document.getElementById('copyCsvBtn').onclick=copyResultsAsCSV;

// ===== Boot =====
(function init(){
  const usp=new URLSearchParams(location.search);
  if(usp.get('cache')){ const u=decodeURIComponent(usp.get('cache')); localStorage.setItem('tmc_public_cache_url',u); }
  const saved=localStorage.getItem('tmc_public_cache_url');
  if(saved){ document.getElementById('publicCacheInput').value=saved; loadPublicCache(saved); }
  else { document.getElementById('pubCacheBox').style.display='block'; addChat('Bot','No public cache configured. Paste the cache link your admin shared.'); }
})();
</script>
</body>
</html>
