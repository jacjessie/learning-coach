<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CASE TRIAGE CONSOLE ‚Äî Home</title>
<style>
/* ===================== Dayforce Blue Theme ===================== */
:root{
  /* Dayforce brand blues */
  --brand-cyan: #1fd1ff;   /* bright cyan */
  --brand-blue: #0a66ff;   /* main blue */
  --brand-deep: #003fe0;   /* deep edge blue */

  /* App surface (dark, readable) */
  --bg:#061a3a;            /* deep navy background */
  --panel:#0a234f;         /* panels */
  --text:#f1f7ff;          /* near white text */
  --muted:#b9d3ff;         /* slate text */

  /* Accents */
  --accent:#0a66ff;        /* primary buttons/focus */
  --accent-2:#1fd1ff;      /* secondary accent (cyan) */
  --ok:#19b36b;
  --warn:#f8b23c;
}

*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);}

/* Header with bright Dayforce gradient */
.header{
  position:sticky; top:0; z-index:2;
  display:flex; align-items:center; gap:14px;
  padding:10px 16px; border-bottom:1px solid rgba(255,255,255,.06);
  color:var(--text);
  background:
    radial-gradient(900px 340px at 0% 0%, rgba(31,209,255,.38), transparent 60%),
    radial-gradient(900px 340px at 100% 100%, rgba(10,102,255,.35), transparent 60%),
    linear-gradient(135deg, var(--brand-blue) 0%, var(--brand-deep) 60%);
  box-shadow: inset 0 -1px 0 rgba(255,255,255,.04);
  backdrop-filter: blur(2px);
}

/* optional blue hero strip beneath header */
.brand-hero {
  height:44px;
  background:
    radial-gradient(800px 300px at 10% 0%, rgba(31,209,255,.35), transparent 55%),
    radial-gradient(900px 340px at 90% 120%, rgba(10,102,255,.30), transparent 60%),
    linear-gradient(135deg, var(--brand-blue), var(--brand-deep));
  border-bottom:1px solid rgba(255,255,255,.06);
  display:flex; align-items:center; padding:0 18px; font-size:12px; color:#e9f4ff; opacity:.9;
}

/* Embedded Dayforce-style logo (SVG) ‚Äî no user upload */
.logoWrap{
  width:36px;height:36px;border-radius:8px;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
  box-shadow: 0 4px 14px rgba(10,102,255,.28);
}
.title{font-size:20px;font-weight:700;letter-spacing:.3px}
.badge{
  background:rgba(255,255,255,.08);
  border:1px solid rgba(31,209,255,.45);
  color:#dff4ff; padding:2px 8px;border-radius:999px;font-size:12px
}

.main{display:grid;grid-template-columns:260px 1fr;gap:16px;padding:16px 20px;min-height:calc(100vh - 68px);}
.sidebar{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px;height:fit-content;position:sticky;top:92px}

.menuBtn{display:flex;gap:10px;align-items:center;width:100%;
  background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);color:var(--text);
  padding:10px;border-radius:10px;margin:6px 0;cursor:pointer;text-align:left;}
.menuBtn.active{
  border-color: rgba(31,209,255,.65);
  box-shadow: 0 0 0 2px rgba(31,209,255,.18) inset, 0 4px 14px rgba(10,102,255,.2);
  background: linear-gradient(135deg, rgba(31,209,255,.08), rgba(10,102,255,.08));
}

.content{min-height:520px}
.panel{
  background: var(--panel);
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px;padding:14px;margin-bottom:16px;
}
.row{display:flex;gap:12px;flex-wrap:wrap}
.input, textarea, select{background:#0b152d;border:1px solid #2a4fa2;color:#d7e6ff;border-radius:10px;padding:10px;font:inherit}
textarea{min-height:80px;resize:vertical}

.btn{
  background: linear-gradient(135deg, var(--brand-cyan), var(--brand-blue));
  color:white;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;
  box-shadow: 0 6px 16px rgba(10,102,255,.25);
  transition: transform .06s ease, box-shadow .2s ease, opacity .15s ease;
}
.btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(10,102,255,.32); }
.btn:active{ transform: translateY(0); box-shadow: 0 6px 16px rgba(10,102,255,.25); }
.btn.secondary{ background:#475569; box-shadow:none; }
.btn.ghost{ background:transparent;border:1px solid #2a4fa2;color:#d7e6ff; box-shadow:none; }

.kpill{
  display:inline-flex;gap:6px;align-items:center;
  background:#0d2e6c;border:1px solid #2556be;color:#d7e8ff;
  border-radius:999px;padding:4px 10px;font-size:12px;margin:3px 6px 0 0
}

.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border:1px solid rgba(255,255,255,.12);padding:8px;vertical-align:top}
.table th{background:rgba(255,255,255,.06)}
a{color:#9ec5ff}
.small{font-size:12px;opacity:.9}
.hint{font-size:12px;color:#cfe0ff;opacity:.85;margin-top:6px}
footer{padding:14px 20px;color:var(--muted)}

.notice{display:flex;gap:8px;align-items:center;background:#132d6a;border:1px solid #295cce;color:#d8e9ff;padding:8px 10px;border-radius:10px;font-size:12px}
.notice:before{content:"‚ö†Ô∏è"}

.twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width: 960px){ .main{grid-template-columns: 1fr;} .twoCol{grid-template-columns:1fr;} .sidebar{position:static} }

/* Feedback embeds */
.iframeBox iframe{width:100%; height:560px; border:0; border-radius:10px;}
</style>
</head>
<body>
  <header class="header">
    <div class="logoWrap" aria-hidden="true">
      <!-- Inline SVG approximating the Dayforce icon (gradient + white 'd') -->
      <svg viewBox="0 0 64 64" width="36" height="36" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Dayforce">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#0a66ff"/>
            <stop offset="1" stop-color="#1fd1ff"/>
          </linearGradient>
        </defs>
        <rect width="64" height="64" rx="8" fill="url(#g)"/>
        <text x="18" y="50" font-size="48" font-weight="800" font-family="Inter, Segoe UI, Arial, sans-serif" fill="#fff">d</text>
      </svg>
    </div>
    <div class="title">CASE TRIAGE CONSOLE</div>
    <span class="badge">Home</span>
    <div style="margin-left:auto" class="small">Dayforce blue ‚Äî bright header & buttons, readable dark UI</div>
  </header>
  <div class="brand-hero">Point every case to the best path.</div>

  <section class="main">
    <aside class="sidebar">
      <button class="menuBtn active" data-view="home">üè† Home</button>
      <button class="menuBtn" data-view="cav">üß≠ Correct Routing (Queue Compass)</button>
      <button class="menuBtn" data-view="probing">üí¨ Probing Questions</button>
      <button class="menuBtn" data-view="notes">üìù Internal Notes</button>
      <button class="menuBtn" data-view="kb">üìö KB Search</button>
      <button class="menuBtn" data-view="feedback">üí° Feedback</button>
      <div class="panel small" style="margin-top:8px">
        This page is static. Admins configure external endpoints (KB cache, feedback embeds) via <code>localStorage</code>. Users do not sign in.
      </div>
    </aside>

    <main class="content">
      <!-- HOME -->
      <div id="view-home" class="panel">
        <h2 style="margin:6px 0 10px 0">Welcome, Triage Team! üëã</h2>
        <div class="notice">Point every case to the best path.</div>
        <p style="margin:10px 0 0 0">Pick a workflow to get started.</p>

        <div class="twoCol" style="margin-top:12px">
          <div class="panel" style="margin:0">
            <h3>üß≠ Correct Routing (Queue Compass)</h3>
            <p class="small">Get a recommended queue, probing questions, and internal note template.</p>
            <button class="btn" onclick="go('cav')">Open</button>
          </div>
          <div class="panel" style="margin:0">
            <h3>üìö KB Search (Excel + PDF)</h3>
            <p class="small">Opens your existing search (tmc_user_g). You can keep using the public cache link.</p>
            <a id="kbLink" class="btn ghost" href="#" target="_blank">Open KB Search</a>
            <div class="hint">Admin can set: <code>localStorage.setItem('tmc_kb_url','...')</code></div>
          </div>
          <div class="panel" style="margin:0">
            <h3>üí¨ Probing Question Banks</h3>
            <p class="small">Module-specific questions to qualify issues quickly.</p>
            <button class="btn secondary" onclick="go('probing')">Browse</button>
          </div>
          <div class="panel" style="margin:0">
            <h3>üìù Internal Notes Formatter</h3>
            <p class="small">Generate clean, consistent internal notes ready to paste into your case.</p>
            <button class="btn secondary" onclick="go('notes')">Use formatter</button>
          </div>
        </div>
      </div>

      <!-- CAV ROUTING -->
      <div id="view-cav" class="panel" style="display:none">
        <h2 style="margin:6px 0 10px 0">üß≠ Correct Routing (CAV Management)</h2>
        <div class="twoCol">
          <div class="panel" style="margin:0">
            <h3>Describe the case</h3>
            <div class="row">
              <div style="flex:1">
                <label class="small">Module</label><br>
                <select id="modSelect" class="input"></select>
              </div>
              <div style="width:160px">
                <label class="small">Urgency</label><br>
                <select id="urgency" class="input">
                  <option value="normal">Normal</option>
                  <option value="high">High</option>
                  <option value="critical">Critical</option>
                </select>
              </div>
            </div>
            <label class="small" style="display:block;margin-top:8px">Issue summary</label>
            <textarea id="summary" placeholder="e.g., Candidate invite emails aren‚Äôt going out after interview is scheduled."></textarea>

            <div class="small" style="margin-top:8px">Common symptoms (optional)</div>
            <div id="symptoms" class="row" style="margin-top:4px"></div>

            <div class="row" style="margin-top:10px">
              <button class="btn" onclick="suggestRoute()">Suggest queue</button>
              <button class="btn ghost" onclick="clearCav()">Clear</button>
              <button class="btn secondary" onclick="downloadCsvTemplate()">Download CSV template</button>
              <label class="btn ghost" style="cursor:pointer">
                Import rules (CSV)
                <input id="csvInput" type="file" accept=".csv" style="display:none" />
              </label>
            </div>
            <div class="hint">Rules are scored by module match + keyword hits. Import a CSV exported from Excel to update.</div>
          </div>

          <div class="panel" style="margin:0">
            <h3>Recommendation</h3>
            <div id="routeBox" class="small" style="opacity:.9">Fill the form and click <em>Suggest queue</em>.</div>
            <div id="altBox" class="small" style="margin-top:8px"></div>

            <h3 style="margin-top:12px">Probing questions</h3>
            <ul id="probeList" class="small"></ul>

            <h3 style="margin-top:12px">Internal notes</h3>
            <textarea id="notesOut" placeholder="[Copyable] Internal notes will appear here‚Ä¶" style="min-height:120px"></textarea>
            <div class="row" style="margin-top:8px">
              <button class="btn ok" onclick="copyNotes()">Copy notes</button>
            </div>
          </div>
        </div>
      </div>

      <!-- FEEDBACK (Microsoft Forms + Excel embed) -->
      <div id="view-feedback" class="panel" style="display:none">
        <h2>üí° Feedback & Ideas</h2>
        <div class="notice">No PII or client-identifying info. Be concise.</div>
        <div class="twoCol" style="margin-top:10px">
          <div class="panel" style="margin:0">
            <h3>Submit (Microsoft Forms)</h3>
            <div id="fbFormWrap" class="iframeBox">
              <div class="hint" id="fbFormHint">
                Admin: set your Form embed <em>src</em> once (no code change):
                <pre style="white-space:pre-wrap;margin:6px 0 0 0;">localStorage.setItem('tmc_form_iframe','https://forms.office.com/Pages/ResponsePage.aspx?...&amp;embed=true')</pre>
              </div>
            </div>
          </div>
          <div class="panel" style="margin:0">
            <h3>Recent feedback (Excel responses)</h3>
            <div id="fbSheetWrap" class="iframeBox">
              <div class="hint" id="fbSheetHint">
                Admin: set your Excel embed <em>src</em> once:
                <pre style="white-space:pre-wrap;margin:6px 0 0 0;">localStorage.setItem('tmc_feedback_embed','https://onedrive.live.com/embed?resid=...&amp;em=2')</pre>
                Tip: use ‚ÄúEmbed‚Äù from OneDrive/Excel Online (workbook set to ‚ÄúAnyone can view‚Äù).
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PLACEHOLDERS -->
      <div id="view-probing" class="panel" style="display:none">
        <h2>üí¨ Probing Question Banks</h2>
        <p class="small">Coming soon ‚Äî you‚Äôll also see questions when you use the CAV workflow.</p>
      </div>
      <div id="view-notes" class="panel" style="display:none">
        <h2>üìù Internal Notes</h2>
        <p class="small">Coming soon ‚Äî quick formatter with placeholders (Client, Case ID, steps taken, artifacts, result).</p>
      </div>
      <div id="view-kb" class="panel" style="display:none">
        <h2>üìö KB Search</h2>
        <p class="small">Use the Home tile to open your existing tmc_user_g search. Admin can store a direct link via <code>localStorage</code>.</p>
      </div>
    </main>
  </section>

  <footer class="small">¬© TMCoach ‚Äî For internal enablement. <span class="badge">No PII</span></footer>

<script>
/* ========= Config from localStorage (set by admin once) ========= */
const KB_URL        = localStorage.getItem('tmc_kb_url')        || '';
const FORM_IFRAME   = localStorage.getItem('tmc_form_iframe')   || '';
const SHEET_EMBED   = localStorage.getItem('tmc_feedback_embed')|| '';

/* ========= Nav ========= */
function go(view){
  document.querySelectorAll('.menuBtn').forEach(b=>b.classList.toggle('active', b.dataset.view===view || (view==='home'&&b.dataset.view==='home')));
  ['home','cav','probing','notes','kb','feedback'].forEach(v=>{
    document.getElementById('view-'+v).style.display = (v===view?'block':'none');
  });
}
document.querySelectorAll('.menuBtn').forEach(b=>b.onclick=()=>go(b.dataset.view));

/* ========= KB link ========= */
(function initKbLink(){
  const a = document.getElementById('kbLink');
  if(KB_URL){ a.href = KB_URL; a.textContent='Open KB Search'; }
  else { a.href = 'tmc_user_g.html'; }
})();

/* ========= Sample routing rules (override by CSV import) ========= */
let routingRules = [
  { module:'Recruiting', signals:['interview','schedule','calendar','invite','slot','availability','panel','hireright','screening'], queue:'Recruiting > Interview Scheduling', confidenceBase:0.75,
    probing:['Which job requisition?','Which candidate(s)?','Which interviewer(s)?','Is calendar provider O365/Google and connected?','Exact error, if any.'],
    notes:'Module: Recruiting | Topic: Interview Scheduling\nSummary: {summary}\nQueue: Recruiting > Interview Scheduling\nInfo collected: {answers}\nLinks: {link1}',
    pdfLabel:'RecruitingGuide', pdfLink:'https://help.dayforce.com/', pdfPage:158 },
  { module:'Recruiting', signals:['import','candidate','csv','workbench','bulk','upload'], queue:'Recruiting > Data Imports', confidenceBase:0.72,
    probing:['Import source (CSV/API)?','Sample file received?','Target fields mapped?','Any rows rejected?'],
    notes:'Module: Recruiting | Topic: Candidate Import\nSummary: {summary}\nQueue: Recruiting > Data Imports\nInfo collected: {answers}\nLinks: {link1}',
    pdfLabel:'RecruitingGuide', pdfLink:'https://help.dayforce.com/', pdfPage:421 },
  { module:'Compensation', signals:['merit','matrix','guidelines','performance','pay grade','comp'], queue:'Compensation > Merit', confidenceBase:0.73,
    probing:['Which cycle (year)?','How many employees impacted?','Matrix config changed recently?','Any custom guidelines?'],
    notes:'Module: Compensation | Topic: Merit Matrix\nSummary: {summary}\nQueue: Compensation > Merit\nInfo collected: {answers}\nLinks: {link1}',
    pdfLabel:'CompensationGuide', pdfLink:'https://help.dayforce.com/', pdfPage:159 },
  { module:'Payroll', signals:['earnings','deductions','options tab','calc','tax','payroll'], queue:'Payroll > Earnings & Deductions', confidenceBase:0.7,
    probing:['Pay group / pay period?','Specific earning/deduction code(s)?','Expected vs actual calculation?','Recent config changes?'],
    notes:'Module: Payroll | Topic: Earnings & Deductions\nSummary: {summary}\nQueue: Payroll > Earnings & Deductions\nInfo collected: {answers}\nLinks: {link1}',
    pdfLabel:'PayrollGuide', pdfLink:'https://help.dayforce.com/', pdfPage:342 },
  { module:'Time', signals:['clock','time','meal break','premium','rule','punch'], queue:'Time > Rules', confidenceBase:0.68,
    probing:['Site/branch?','Rule name & version?','Who is affected?','Exact punches/timeframe?'],
    notes:'Module: Time | Topic: Meal Break / Clock Rules\nSummary: {summary}\nQueue: Time > Rules\nInfo collected: {answers}\nLinks: {link1}',
    pdfLabel:'TimeGuide', pdfLink:'https://help.dayforce.com/', pdfPage:201 },
  { module:'Learning', signals:['enroll','learning plan','rules','course','assignment'], queue:'Learning > Configuration', confidenceBase:0.66,
    probing:['Which courses/plans?','Enrollment criteria?','Specific users or groups?','Expected vs actual behavior?'],
    notes:'Module: Learning | Topic: Enrollment Rules\nSummary: {summary}\nQueue: Learning > Configuration\nInfo collected: {answers}\nLinks: {link1}',
    pdfLabel:'LearningGuide', pdfLink:'https://help.dayforce.com/', pdfPage:135 }
];

const modules = [...new Set(routingRules.map(r=>r.module))].sort();
const symptomBank = ['Access/Permissions','Configuration','Integration/API','Data Issue','Bug/Unexpected','How-to/Training'];

/* ========= Populate CAV UI ========= */
(function initCAV(){
  const modSel = document.getElementById('modSelect');
  modules.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; modSel.appendChild(o); });
  const symWrap = document.getElementById('symptoms');
  symptomBank.forEach(s=>{
    const b=document.createElement('button'); b.className='kpill'; b.type='button'; b.textContent=s;
    b.onclick=()=>b.classList.toggle('active');
    symWrap.appendChild(b);
  });
})();

/* ========= CAV scoring ========= */
function tokenize(s){ return (s||'').toLowerCase().split(/[^a-z0-9]+/).filter(Boolean); }
function scoreRule(rule, selectedModule, summaryTokens, symptomTags){
  let score = 0;
  if(rule.module.toLowerCase() === (selectedModule||'').toLowerCase()) score += 0.5;
  const sig = (rule.signals||[]).map(x=>x.toLowerCase());
  const hits = summaryTokens.filter(t=>sig.includes(t));
  score += Math.min(0.4, hits.length * 0.07);
  if(symptomTags.some(t => rule.signals.join(' ').toLowerCase().includes(t.toLowerCase()))) score += 0.1;
  score += (rule.confidenceBase||0);
  return {score, hits};
}

function suggestRoute(){
  const mod = document.getElementById('modSelect').value;
  const urg = document.getElementById('urgency').value;
  const summary = document.getElementById('summary').value.trim();
  const sym = [...document.querySelectorAll('#symptoms .kpill.active')].map(x=>x.textContent);
  if(!summary){ alert('Please enter an issue summary.'); return; }

  const toks = tokenize(summary);
  const scored = routingRules.map(r => ({ rule:r, ...scoreRule(r,mod,toks,sym) })).sort((a,b)=>b.score-a.score);
  const top = scored[0];
  const alts = scored.slice(1,4);

  if(!top){ document.getElementById('routeBox').innerHTML = 'No matching rule yet. Try adding more detail.'; return; }

  const confPct = Math.min(99, Math.round(top.score*100));
  let routeHTML = `<div class="notice" style="border-color:#2a4fa2">Recommended queue: <strong>${top.rule.queue}</strong> <span class="badge" style="margin-left:8px">${confPct}%</span></div>`;
  const why = top.hits.length ? `Matched keywords: `+top.hits.map(h=>`<span class="kpill">${h}</span>`).join(' ') : 'Based on module & historical signals.';
  routeHTML += `<div class="small" style="margin-top:6px">${why}</div>`;
  if(top.rule.pdfLink){ routeHTML += `<div class="small" style="margin-top:6px">Link: <a href="${top.rule.pdfLink}#page=${top.rule.pdfPage||1}" target="_blank">${top.rule.pdfLabel||'Guide'} p.${top.rule.pdfPage||'?'}</a></div>`; }
  document.getElementById('routeBox').innerHTML = routeHTML;

  const ul=document.getElementById('probeList'); ul.innerHTML='';
  (top.rule.probing||[]).forEach(q=>{ const li=document.createElement('li'); li.textContent=q; ul.appendChild(li); });

  const answersHint = (top.rule.probing||[]).map(q=>`- ${q}`).join('\n');
  const notes = (top.rule.notes||'').replace('{summary}', summary).replace('{answers}', answersHint).replace('{link1}', top.rule.pdfLink||'');
  document.getElementById('notesOut').value = notes;

  const altDiv=document.getElementById('altBox'); altDiv.innerHTML='';
  if(alts.length){
    let s='<div class="small"><strong>Other possible queues</strong></div><table class="table small"><tr><th>Queue</th><th>Why</th><th>Score</th></tr>';
    alts.forEach(a=>{
      const whyA = a.hits.length? a.hits.join(', ') : 'Signals overlap';
      s += `<tr><td>${a.rule.queue}</td><td>${whyA}</td><td>${Math.round(a.score*100)}%</td></tr>`;
    });
    s+='</table>'; altDiv.innerHTML=s;
  }
}

function clearCav(){
  document.getElementById('summary').value='';
  document.querySelectorAll('#symptoms .kpill.active').forEach(x=>x.classList.remove('active'));
  document.getElementById('routeBox').innerHTML='Fill the form and click <em>Suggest queue</em>.';
  document.getElementById('altBox').innerHTML='';
  document.getElementById('probeList').innerHTML='';
  document.getElementById('notesOut').value='';
}
function copyNotes(){ const el=document.getElementById('notesOut'); if(!el.value) return; el.select(); document.execCommand('copy'); el.blur(); }

/* ========= CSV Template & Import ========= */
function downloadCsvTemplate(){
  const csv = [
    'Module,Signals,Queue,Probing,NotesTemplate,PDFLabel,PDFLink,PDFPage',
    'Recruiting,"interview,schedule,calendar,invite,slot,availability,panel,hireright,screening","Recruiting > Interview Scheduling","Which job requisition?;Which candidate(s)?;Which interviewer(s)?;Is calendar provider O365/Google and connected?;Exact error, if any.","Module: Recruiting | Topic: Interview Scheduling\\nSummary: {summary}\\nQueue: Recruiting > Interview Scheduling\\nInfo collected: {answers}\\nLinks: {link1}",RecruitingGuide,https://help.dayforce.com/,158',
    'Recruiting,"import,candidate,csv,workbench,bulk,upload","Recruiting > Data Imports","Import source (CSV/API)?;Sample file received?;Target fields mapped?;Any rows rejected?","Module: Recruiting | Topic: Candidate Import\\nSummary: {summary}\\nQueue: Recruiting > Data Imports\\nInfo collected: {answers}\\nLinks: {link1}",RecruitingGuide,https://help.dayforce.com/,421'
  ].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='tmc_routing_template.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url), 1200);
}
document.getElementById('csvInput')?.addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const text = await f.text();
  const rows = text.split(/\r?\n/).filter(Boolean).map(r=>r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(x=>x.replace(/^"+|"+$/g,'')));
  const head = rows.shift().map(h=>h.trim().toLowerCase());
  const idx = (h)=>head.indexOf(h);
  const list = rows.map(r=>({
    module: r[idx('module')]||'',
    signals: (r[idx('signals')]||'').split(/\s*,\s*/).filter(Boolean),
    queue: r[idx('queue')]||'',
    probing: (r[idx('probing')]||'').split(/\s*;\s*/).filter(Boolean),
    notes: r[idx('notestemplate')]||'',
    pdfLabel: r[idx('pdflabel')]||'',
    pdfLink: r[idx('pdflink')]||'',
    pdfPage: parseInt(r[idx('pdfpage')])||1,
    confidenceBase: 0.7
  })).filter(x=>x.module && x.queue);
  if(!list.length){ alert('No valid rows found in CSV.'); return; }
  routingRules = list;
  const modSel=document.getElementById('modSelect'); modSel.innerHTML='';
  [...new Set(routingRules.map(r=>r.module))].sort().forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=m; modSel.appendChild(o); });
  alert('Imported '+list.length+' rules.');
});

/* ========= Feedback embeds (Forms + Excel) ========= */
(function renderFeedbackEmbeds(){
  const formWrap  = document.getElementById('fbFormWrap');
  const sheetWrap = document.getElementById('fbSheetWrap');

  if (FORM_IFRAME && formWrap){
    document.getElementById('fbFormHint')?.remove();
    const f = document.createElement('iframe');
    f.src = FORM_IFRAME; f.title = 'Feedback form';
    formWrap.appendChild(f);
  }
  if (SHEET_EMBED && sheetWrap){
    document.getElementById('fbSheetHint')?.remove();
    const s = document.createElement('iframe');
    s.src = SHEET_EMBED; s.title = 'Feedback list';
    sheetWrap.appendChild(s);
  }
})();

/* ========= Init ========= */
go('home');
</script>
</body>
</html>
